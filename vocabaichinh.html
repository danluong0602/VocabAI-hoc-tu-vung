<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
   <title>VocabAI</title>
      <link rel="icon" type="image/png" href="logo.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
:root {
      /* New Color Palette from Section 3 */
      --primary-dark: #711000;
      --accent-red: #9A0A13;
      --gold-light: #F2CE84;
      --bg-cream: #FAF0D5;
      --amber: #E69739;
      
      --bg: var(--bg-cream);
      --nav: var(--primary-dark);
      --accent: var(--accent-red);
      --muted: #8C6D5E;
      --card: #ffffff;
      --glass: rgba(255, 255, 255, 0.6);
      --radius: 28px;
      --radius-sm: 12px;
      --text: #3D0900;
      --shadow: 0 6px 18px rgba(113, 16, 0, 0.08);
      --brand-bg: var(--gold-light);
      --header-h: 70px;
      --streak: var(--amber);
      --success: #2e7d32;
      --target-blue: var(--primary-dark);
      --tag-bg: #FDF5E6;
      --tag-color: var(--accent-red);
      
      --excel-green: var(--accent-red);
      --excel-header-bg: #F9EBC8;
      --excel-border: #D9C5A0;
      --excel-select-bg: #FEF3D8;
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', 'Lexend', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      margin: 0;
      /* Ensure body context for fixed elements */
      min-height: 100vh;
    }

    /* --- TET DECORATION LAYER (Z-INDEX 0) --- */
    /* Layer n√†y n·∫±m d∆∞·ªõi c√πng (z-index: 0) ƒë·ªÉ hoa kh√¥ng che ch·ªØ */
    #tet-decor-layer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; 
        pointer-events: none; /* Click xuy√™n qua */
        overflow: hidden;
    }

    .tet-branch-svg {
        position: absolute;
        top: 0;
        width: 350px;
        max-width: 40vw;
        height: auto;
        opacity: 0.95;
        filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.15));
    }
    
    .tet-branch-svg.left {
        left: -20px;
        top: -20px;
    }
    
    .tet-branch-svg.right {
        right: -20px;
        top: -20px;
        transform: scaleX(-1); /* L·∫≠t ng∆∞·ª£c cho b√™n ph·∫£i */
    }

    .falling-flower {
        position: absolute;
        top: -10%;
        user-select: none;
        pointer-events: none;
        z-index: 0; /* C√πng l·ªõp v·ªõi c√†nh hoa */
        opacity: 0.8;
    }

    /* Animation hoa r∆°i & xoay */
    @keyframes flower-fall {
        0% { transform: translateY(0) rotate(0deg) translateX(0); opacity: 0; }
        10% { opacity: 0.9; }
        80% { opacity: 0.8; }
        100% { transform: translateY(110vh) rotate(360deg) translateX(50px); opacity: 0; }
    }
    /* ---------------------------------------- */

    /* Topbar - Z-Index cao h∆°n ƒë·ªÉ n·ªïi l√™n tr√™n hoa */
    .topbar {
      background: var(--nav);
      color: #fff;
      padding: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 50; 
      overflow-x: clip;
    }
    .topbar-inner {
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      height: var(--header-h);
    }
    .brand { display: flex; align-items: center; gap: 24px; height: 100%; }
    
    .brand-bubble {
      background: var(--brand-bg);
      color: var(--accent);
      padding: 0 35px 0 10px;
      border-radius: 0 50px 50px 0;
      font-weight: 800;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 12px;
      height: 100%;
      margin-left: -20px;
      box-shadow: 4px 0 15px rgba(0,0,0,0.1);
      flex-shrink: 0;
      position: relative;
    }
    
    .brand-bubble::before {
      content: '';
      position: absolute;
      top: 0;
      right: 100%;
      width: 100vw;
      height: 100%;
      background: var(--brand-bg);
    }
    
    .logo-placeholder {
      height: 45px;
      width: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .logo-placeholder img { height: 100%; width: auto; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
    
    .nav { display: flex; gap: 4px; align-items: center; }
    .nav-item {
      color: rgba(255,255,255,.75);
      padding: 8px 16px;
      border-radius: 12px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    .nav-item:hover { color: var(--gold-light); }
    .nav-item.active { background: rgba(255,255,255,0.12); font-weight: 700; color: var(--gold-light); }

    .top-actions { display: flex; align-items: center; gap: 14px; }
    
    .streak-header {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(230, 151, 57, 0.15);
      padding: 6px 12px;
      border-radius: 14px;
      color: var(--streak);
      font-weight: 700;
      font-size: 14px;
      border: 1px solid rgba(230, 151, 57, 0.2);
    }

    .lang-container { position: relative; }
    .lang { 
      background: rgba(255,255,255,0.08); 
      padding: 7px 12px; 
      border-radius: 10px; 
      font-size: 13px; 
      cursor: pointer; 
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 100px;
      color: #fff;
    }
    .lang-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      margin-top: 8px;
      overflow: hidden;
      display: none;
      z-index: 200;
      border: 1px solid var(--excel-border);
    }
    .lang-dropdown.show { display: block; }
    .lang-option { padding: 10px 16px; color: var(--text); font-size: 13px; cursor: pointer; }
    .lang-option:hover { background: var(--bg-cream); color: var(--accent); }
    .lang-option.active { font-weight: 700; color: var(--accent); background: var(--bg-cream); }

    .user { background: var(--gold-light); color: var(--primary-dark); padding: 7px 16px; border-radius: 20px; font-weight: 700; font-size: 13px; }

    /* Sections */
    /* IMPORTANT: Raise content z-index above decor layer (10 > 0) */
    .container { 
        max-width: 1200px; 
        margin: 30px auto; 
        padding: 0 20px; 
        position: relative; 
        z-index: 10; 
    }
    
    .view-section { display: none; }
    .view-section.active { display: block; }

    /* Titles */
    .page-title {
      color: var(--primary-dark);
      font-size: 28px;
      margin: 10px 0 25px;
      display: flex;
      align-items: center;
      gap: 15px;
      font-weight: 800;
    }
    .link-btn {
      background: #fff;
      border: 1px solid var(--excel-border);
      color: var(--primary-dark);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .link-btn:hover { background: var(--gold-light); color: var(--accent); border-color: var(--amber); }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(113, 16, 0, 0.05);
    }
    .ai-card { border-radius: 40px; position: relative; overflow: hidden; }
    .ai-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 6px; height: 100%;
      background: var(--accent);
    }
    .card-title { color: var(--accent); font-weight: 800; margin: 0 0 20px; font-size: 19px; text-transform: uppercase; letter-spacing: 0.8px; display: flex; align-items: center; gap: 10px; }

    /* Form */
    .ai-form .row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .ai-form label { flex: 1; min-width: 220px; display: flex; flex-direction: column; font-size: 11px; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    
    .ai-form input, .ai-form select {
      margin-top: 8px;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--excel-border);
      background: #fffdf9;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s;
      color: var(--text);
    }
    .ai-form input:focus {
      outline: none;
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(154, 10, 19, 0.1);
    }

    .form-actions { display: flex; gap: 15px; margin-top: 10px; }
    .btn {
      padding: 15px 28px; border-radius: 14px; border: 0; cursor: pointer;
      font-weight: 700; font-size: 15px; display: flex; align-items: center;
      justify-content: center; gap: 10px; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: white; flex: 2; box-shadow: 0 4px 12px rgba(154, 10, 19, 0.2); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(113, 16, 0, 0.3); }
    .btn-ghost { background: var(--gold-light); color: var(--primary-dark); flex: 1; }
    .btn-ghost:hover { background: var(--amber); color: #fff; }

    /* Table */
    .table-wrap { overflow-x: auto; margin-top: 10px; border-radius: 20px; border: 1px solid var(--excel-border); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1200px; background: #fff; }
    thead th {
      background: var(--excel-header-bg); color: var(--primary-dark); padding: 16px; text-align: left;
      font-weight: 800; border-bottom: 2px solid var(--excel-border);
      text-transform: uppercase; font-size: 12px;
    }
    tbody td { padding: 18px 16px; border-bottom: 1px solid var(--bg-cream); vertical-align: middle; }

    /* Controls */
    .icon-btn {
      background: var(--bg-cream); border-radius: 10px; width: 38px; height: 38px;
      border: 1px solid var(--excel-border); cursor: pointer; display: inline-flex;
      align-items: center; justify-content: center; color: var(--primary-dark); transition: all 0.2s;
    }
    .icon-btn:hover { background: var(--gold-light); color: var(--accent); }
    .icon-btn.active { color: var(--success); background: #eef7ee; border-color: var(--success); }
    .icon-btn.play { color: var(--accent); }

    /* Library */
    .topic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }
    .topic-card {
      background: #fff;
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid rgba(113, 16, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: relative; /* For Menu Positioning */
    }
    .topic-card:hover { transform: translateY(-5px); border-color: var(--amber); }
    .topic-icon {
      width: 50px; height: 50px; background: var(--bg-cream); color: var(--amber);
      border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 22px;
    }

    /* Library Topic Menu Styles */
    .topic-menu-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: transparent;
        border: none;
        font-size: 18px;
        color: var(--muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
        z-index: 10;
    }
    .topic-menu-btn:hover { background: var(--bg-cream); color: var(--accent); }
    
    .topic-dropdown {
        position: absolute;
        top: 45px;
        right: 15px;
        background: #fff;
        border: 1px solid var(--excel-border);
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        display: none;
        flex-direction: column;
        z-index: 20;
        min-width: 140px;
        overflow: hidden;
    }
    .topic-dropdown.show { display: flex; }
    .topic-action {
        padding: 10px 15px;
        font-size: 13px;
        color: var(--text);
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        transition: 0.1s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .topic-action:hover { background: var(--bg-cream); color: var(--accent); }
    .topic-action.delete { color: #d32f2f; }
    .topic-action.delete:hover { background: #ffebee; }

    /* Library Controls (NEW) */
    .lib-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-box { position: relative; flex: 1; min-width: 200px; }
    .search-box input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 14px; border: 1px solid var(--excel-border); outline: none; transition: all 0.2s; background: #fff; }
    .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(154, 10, 19, 0.1); }
    .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .btn-export { background: #2e7d32; color: white; padding: 12px 20px; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
    .btn-export:hover { background: #1b5e20; transform: translateY(-2px); }

    /* Stats Section */
    .glass-stats { background: #fff; border-radius: 2rem; border: 1px solid rgba(113, 16, 0, 0.1); padding: 40px; }
    .streak-fire { animation: flame-pulse 2s infinite; }
    @keyframes flame-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .heatmap-grid { display: grid; grid-template-rows: repeat(7, 12px); grid-auto-flow: column; grid-auto-columns: 12px; gap: 4px; }
    .heatmap-cell { width: 12px; height: 12px; border-radius: 3px; }
    .lvl-0 { background-color: #f0e6d2; }
    .lvl-1 { background-color: var(--gold-light); }
    .lvl-2 { background-color: var(--amber); }
    .lvl-3 { background-color: var(--accent-red); }
    .lvl-4 { background-color: var(--primary-dark); }
    .badge-locked { opacity: 0.2; filter: grayscale(1); }
    .badge-unlocked { opacity: 1; filter: none; transform: scale(1.1); }

    /* Modals */
    .modal {
      position: fixed; inset: 0; background: rgba(113, 16, 0, 0.15);
      backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; z-index: 200;
    }
    .modal[aria-hidden="false"] { display: flex; }
    .modal-panel {
      background: var(--card); width: 550px; padding: 35px; border-radius: 30px;
      position: relative; box-shadow: 0 30px 80px rgba(113,16,0,0.2);
      border: 1px solid var(--excel-border);
    }
    .modal-panel.large { width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; }
    .modal-close {
      position: absolute; right: 20px; top: 20px; border: 0;
      background: var(--bg-cream); width: 34px; height: 34px; border-radius: 50%; cursor: pointer;
    }

    /* Excel-style Guide Styles (From Section 3) */
    .excel-guide-wrapper {
      margin-top: 25px;
      border: 1px solid var(--excel-border);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      display: flex;
      flex-direction: column;
      font-family: "Segoe UI", "Calibri", sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .excel-top-bar { background-color: var(--primary-dark); color: var(--gold-light); padding: 8px 15px; font-size: 14px; font-weight: 500; display: flex; align-items: center; }
    .excel-menu { display: flex; background: white; padding: 5px 20px; border-bottom: 1px solid var(--excel-border); gap: 20px; font-size: 13px; }
    .excel-menu span { cursor: pointer; padding: 5px 0; color: var(--muted); }
    .excel-menu span.active { border-bottom: 3px solid var(--accent); font-weight: bold; color: var(--accent); }
    .formula-bar { display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px solid var(--excel-border); background: #fff; font-size: 13px; }
    .name-box { width: 80px; border-right: 1px solid var(--excel-border); padding: 2px 10px; text-align: center; color: var(--accent); font-weight: bold; }
    .fx-icon { padding: 0 10px; color: var(--muted); font-style: italic; font-weight: bold; font-family: serif; }
    .formula-input { flex-grow: 1; padding: 2px 10px; outline: none; border-left: 1px solid var(--excel-border); color: var(--text); }
    .excel-sheet-container { overflow: auto; max-height: 400px; background-color: var(--bg-cream); }
    .excel-table { border-collapse: collapse; table-layout: fixed; width: max-content; background: white; margin: 0; }
    .excel-table th { background-color: var(--excel-header-bg); border: 1px solid var(--excel-border); font-weight: normal; font-size: 12px; color: var(--primary-dark); height: 25px; position: sticky; top: 0; z-index: 10; }
    .excel-table .row-index { width: 40px; background-color: var(--excel-header-bg); text-align: center; border: 1px solid var(--excel-border); font-size: 11px; color: var(--muted); }
    .excel-table td { border: 1px solid var(--bg-cream); padding: 4px 8px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 22px; color: var(--text); cursor: cell; }
    .excel-table .col-header { background-color: #FEF9EB; font-weight: bold; text-align: center; color: var(--accent); position: sticky; top: 25px; z-index: 9; }
    .excel-table tr:hover td { background-color: var(--bg-cream); }
    .excel-sheet-tabs { background: var(--excel-header-bg); border-top: 1px solid var(--excel-border); padding: 5px 20px; font-size: 12px; display: flex; align-items: center; gap: 15px; }
    .excel-tab { background: white; padding: 5px 15px; border: 1px solid var(--excel-border); border-bottom: none; color: var(--accent); font-weight: bold; border-radius: 4px 4px 0 0; }
    .excel-status-bar { background: var(--primary-dark); color: var(--gold-light); font-size: 11px; padding: 4px 15px; }

    /* Flashcard UI */
    .flashcard-container { perspective: 1000px; width: 100%; max-width: 450px; height: 320px; margin: 30px auto; cursor: pointer; }
    .flashcard { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 30px; }
    .flashcard.flipped { transform: rotateY(180deg); }
    .flashcard-front, .flashcard-back {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border-radius: 30px; padding: 35px; box-shadow: 0 15px 40px rgba(113, 16, 0, 0.08); background: #fff;
      border: 2px solid var(--bg-cream); text-align: center;
    }
    .flashcard-back { transform: rotateY(180deg); background: var(--bg-cream); }
    .fc-word { font-size: 36px; font-weight: 800; color: var(--accent); margin-bottom: 8px; }
    .fc-meaning { font-size: 24px; font-weight: 700; color: var(--primary-dark); }
    .fc-progress { width: 100%; max-width: 450px; height: 8px; background: var(--gold-light); border-radius: 10px; margin: 20px auto 0; overflow: hidden; opacity: 0.5; }
    .fc-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; }

    #notification {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: var(--primary-dark); color: #fff; padding: 14px 28px; border-radius: 50px;
      font-size: 14px; z-index: 1000; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    /* Review View Specific */
    .review-breadcrumb { font-size: 12px; color: var(--muted); margin-bottom: 10px; font-weight: 700; text-transform: uppercase; }
    .review-main-card {
      background: #fff; border-radius: 40px; padding: 40px;
      box-shadow: 0 20px 50px rgba(113,16,0,0.06); min-height: 500px;
      display: flex; flex-direction: column; align-items: center;
      max-width: 800px; margin: 0 auto; position: relative; border: 1px solid var(--excel-border);
    }
    .tag { padding: 6px 14px; border-radius: 50px; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; align-self: flex-start; }
    .tag-blue { background: var(--bg-cream); color: var(--accent); border: 1px solid var(--gold-light); }
    .tag-dark { background: var(--primary-dark); color: #fff; }
    .translation-vn { font-size: 36px; font-weight: 800; color: var(--text); margin-bottom: 6px; }
    .ipa-block { display: flex; align-items: center; gap: 12px; color: var(--muted); font-weight: 600; font-size: 18px; }
    .review-input { width: 100%; border: none; border-bottom: 3px solid var(--gold-light); font-size: 40px; font-weight: 800; text-align: center; padding: 10px; color: var(--accent); outline: none; background: transparent; transition: border-color 0.3s; }
    
    /* Error Checking Styles */
    .feedback-chars { display: flex; justify-content: center; gap: 6px; margin-top: 15px; font-size: 24px; font-weight: 800; font-family: 'Inter', monospace; min-height: 35px; }
    .char-correct { color: var(--success); }
    .char-wrong { color: var(--accent); text-decoration: underline; text-decoration-thickness: 3px; }

    .btn-srs { flex: 1; flex-direction: column; padding: 12px; border-radius: 20px; border: 2px solid var(--gold-light); background: #fff; display: flex; align-items: center; }

    /* =========================
       COMMUNITY (b·ªï sung CSS)
       ========================= */
    /* m√†u + ti·ªán √≠ch */
    .bg-deep-red{background-color:#9A0A13}
    .bg-dark-red{background-color:#711000}
    .bg-gold{background-color:#F2CE84}
    .bg-warm-orange{background-color:#E69739}
    .text-deep-red{color:#9A0A13}
    .text-dark-red{color:#711000}
    .text-gold{color:#F2CE84}
    .text-warm-orange{color:#E69739}
    .shadow-soft{box-shadow:0 4px 20px -2px rgba(113,16,0,0.08)}
    .hover-card:hover{transform:translateY(-2px);transition:all .2s ease}
    /* scrollbars */
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:var(--bg-cream)}
    ::-webkit-scrollbar-thumb{background:var(--gold-light);border-radius:10px}
    .chat-container{height:280px;overflow-y:auto}
    .ai-chat-container{height:320px;overflow-y:auto}
    .chat-history{height:350px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:#f9f9f9;padding:15px}
    
    /* S·ª≠a ƒë·ªïi: Th√™m overflow-x: auto ƒë·ªÉ bong b√≥ng chat kh√¥ng b·ªã v·ª° khi c√≥ b·∫£ng r·ªông */
    .chat-bubble{padding:10px 15px;border-radius:18px;max-width:85%;font-size:13px;word-break:break-word;overflow-x:auto;}
    
    .chat-bubble.me{background:var(--primary-dark);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
    .chat-bubble.other{background:#eee;color:#333;align-self:flex-start;border-bottom-left-radius:4px}
    
    /* === B·ªî SUNG: STYLING CHO MARKDOWN TRONG AI CHAT BUBBLE === */
    .chat-bubble.other h1, .chat-bubble.other h2, .chat-bubble.other h3 {
        margin: 10px 0 5px;
        font-weight: 800;
        color: var(--primary-dark);
        font-size: 14px;
        display: block;
    }
    .chat-bubble.other strong {
        font-weight: 800;
        color: var(--accent);
    }
    .chat-bubble.other ul, .chat-bubble.other ol {
        margin: 5px 0 10px 20px;
        list-style-type: disc;
    }
    .chat-bubble.other li {
        margin-bottom: 4px;
    }
    .chat-bubble.other p {
        margin-bottom: 8px;
        line-height: 1.5;
    }
    .chat-bubble.other p:last-child {
        margin-bottom: 0;
    }
    .chat-bubble.other code {
        background: rgba(0,0,0,0.05);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        color: var(--accent);
    }

    /* ƒê·ªãnh d·∫°ng b·∫£ng trong chat AI */
    .chat-bubble.other table {
        width: 100%;
        max-width: 100%;
        border-collapse: collapse;
        margin: 8px 0;
        font-size: 11px; /* Font nh·ªè h∆°n ƒë·ªÉ v·ª´a khung */
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.1);
    }
    .chat-bubble.other th {
        background-color: var(--bg-cream);
        color: var(--primary-dark);
        font-weight: bold;
        padding: 8px;
        border-bottom: 2px solid rgba(0,0,0,0.1);
        text-align: left;
    }
    .chat-bubble.other td {
        padding: 8px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        color: #333;
    }
    .chat-bubble.other tr:last-child td {
        border-bottom: none;
    }
    /* ========================================================== */

    .pinned-vocab{background:#fffbeb;border:1px solid #fde68a;padding:15px;border-radius:20px}
    .goal-card{border-left:5px solid var(--accent-red);background:#fff;padding:15px;border-radius:0 15px 15px 0}

    /* Comment */
    .comment-area{display:none}
    .comment-area.active{display:block}
    .reply-input-wrapper{display:none}
    .reply-input-wrapper.active{display:flex}

    /* Progress day/task */
    .progress-day{display:flex;flex-direction:column;align-items:center;gap:8px;flex:1;min-width:60px;padding:10px;border-radius:12px;background:var(--bg-cream);opacity:.5}
    .progress-day.active{opacity:1;border:2px solid var(--amber);background:#fff}
    .progress-day.completed{background:#dcfce7;opacity:1}

    /* Multimedia in chat */
    .chat-image{border-radius:12px;max-width:100%;height:auto;margin-top:5px;border:1px solid rgba(0,0,0,0.1)}
    .chat-file{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:8px 12px;border-radius:10px;margin-top:5px}

    /* Poll (sidebar) */
    .poll-card-sidebar{background:#fefcf6;border:1px solid #f2ce84;border-radius:20px;padding:15px;width:100%;box-shadow:0 2px 8px rgba(113,16,0,0.05)}
    .poll-option-bar{height:8px;background:#eee;border-radius:4px;overflow:hidden;margin-top:4px}
    .poll-option-fill{background:var(--accent-red);height:100%;transition:width .3s ease}

    .recording-pulse{animation:pulse-red 1s infinite;color:#ef4444}
    @keyframes pulse-red{0%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.7}100%{transform:scale(1);opacity:1}}

    .task-row{transition:all .2s;border-radius:16px;margin-bottom:8px;padding:12px 16px;display:flex;align-items:center;gap:15px;border:1px solid #f3f4f6}
    .task-row.active{border-color:var(--gold-light);background:#fefce8}
    .task-row.done{background:#f0fdf4;border-color:#bbf7d0}
    .task-row.locked{opacity:.4;background:#f9fafb;cursor:not-allowed}

    /* =========================
       NEW LAYOUT 2025: BENTO GRID DASHBOARD (UPDATED & BEAUTIFIED)
       ========================= */
    .bento-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 25px;
        padding-bottom: 40px;
    }
    
    @media (min-width: 1024px) {
        .bento-grid {
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: minmax(180px, auto);
        }
        .span-1 { grid-column: span 1; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }
        .row-span-2 { grid-row: span 2; }
    }
    
    /* Card Styles */
    .bento-card {
        background: #fff;
        border-radius: 24px;
        padding: 24px;
        border: 1px solid rgba(113, 16, 0, 0.08);
        box-shadow: 0 10px 30px -5px rgba(113, 16, 0, 0.05);
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        height: 100%;
    }
    
    .bento-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px -5px rgba(113, 16, 0, 0.12);
        border-color: var(--gold-light);
    }

    .bento-card.dark-bg {
        background: linear-gradient(135deg, #711000 0%, #3d0900 100%);
        color: #fff;
        border: none;
    }
    .bento-card.dark-bg .disco-title { color: #F2CE84; }
    .bento-card.dark-bg .disco-icon { 
        background: rgba(255,255,255,0.15); 
        color: #F2CE84; 
        backdrop-filter: blur(5px);
    }
    
    /* Decorative Tags */
    .bento-tag {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 10px;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 5;
    }
    .tag-hot { background: rgba(255,75,75,0.15); color: #ff4b4b; backdrop-filter: blur(4px); }
    .tag-new { background: #e0f2fe; color: #0284c7; }
    .tag-pro { background: #fefce8; color: #ca8a04; }

    /* Header Styling */
    .disco-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding-bottom: 12px;
    }
    .bento-card.dark-bg .disco-header { border-color: rgba(255,255,255,0.1); }

    .disco-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--bg-cream);
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }
    .disco-title {
        font-weight: 800;
        font-size: 16px;
        color: var(--primary-dark);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Game Area Specifics */
    .game-container {
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        flex: 1;
        position: relative;
        overflow: hidden;
        min-height: 300px;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    }
    .game-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
    }
    .falling-word {
        position: absolute;
        padding: 8px 16px;
        background: #fff;
        color: #711000;
        border-radius: 20px;
        font-weight: 700;
        font-size: 14px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        white-space: nowrap;
        z-index: 10;
    }
    .game-over-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.85);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20;
        backdrop-filter: blur(5px);
    }
    .game-score {
        position: absolute; top: 10px; right: 15px;
        font-weight: 800; color: rgba(255,255,255,0.8);
        font-size: 14px;
    }

    /* Roleplay & Chat Specifics */
    .rp-chat {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 15px;
        flex: 1;
        overflow-y: auto;
        border: 1px solid rgba(0,0,0,0.05);
        height: 250px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .rp-bubble {
        padding: 10px 14px;
        border-radius: 14px;
        font-size: 13px;
        line-height: 1.5;
        max-width: 85%;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .rp-bubble:hover { transform: scale(1.01); }
    .rp-ai {
        background: #fff;
        border: 1px solid #e5e7eb;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    .rp-user {
        background: var(--primary-dark);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    .rp-bubble.translated {
        font-style: italic;
        background: var(--bg-cream);
        color: var(--primary-dark);
        border-color: var(--gold-light);
    }

    /* Creative Workshop Input */
    .cw-textarea {
        width: 100%;
        min-height: 120px;
        padding: 15px;
        border-radius: 16px;
        border: 1px solid var(--excel-border);
        background: #fdfbf7;
        resize: none;
        font-size: 14px;
        margin-bottom: 10px;
        transition: 0.2s;
        font-family: inherit;
    }
    .cw-textarea:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(154, 10, 19, 0.05); }

    .cw-result {
        background: #f0fdf4;
        border: 1px dashed #2e7d32;
        padding: 15px;
        border-radius: 12px;
        font-size: 13px;
        margin-top: 15px;
        display: none;
    }

    /* Challenge List */
    .dc-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #f3f4f6;
        cursor: pointer;
        transition: all 0.2s;
    }
    .dc-item:hover { background: #fff; border-color: var(--gold-light); transform: translateX(2px); }
    .dc-check {
        width: 20px; height: 20px; border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex; align-items: center; justify-content: center;
        color: transparent;
        font-size: 10px;
        transition: all 0.2s;
    }
    .dc-item.completed .dc-check {
        background: var(--success);
        border-color: var(--success);
        color: white;
    }
    .dc-item.completed .dc-text {
        text-decoration: line-through;
        opacity: 0.6;
    }
    .dc-text { font-size: 13px; font-weight: 600; color: #4b5563; }

    /* Button Utilities */
    .full-w-btn {
        width: 100%;
        background: var(--primary-dark);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .full-w-btn:hover { background: var(--accent); }
    .ghost-btn { background: transparent; color: #666; border: 1px solid #ddd; }
    .ghost-btn:hover { background: #f3f4f6; color: #333; }

    /* Network Vis */
    .net-canvas {
        flex: 1;
        background-image: radial-gradient(#ddd 1px, transparent 1px);
        background-size: 20px 20px;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        display: flex; align-items: center; justify-content: center;
    }
    .net-node {
        position: absolute;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        background: white;
        border: 2px solid var(--accent);
        color: var(--primary-dark);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 2;
    }
    .net-center { z-index: 3; background: var(--primary-dark); color: white; border-color: var(--primary-dark); transform: scale(1.2); }
    .net-line { position: absolute; height: 2px; background: #ddd; transform-origin: 0 50%; z-index: 1; top: 50%; left: 50%; }

    /* Dictation */
    .dict-box { text-align: center; }
    .dict-input {
        width: 100%; border: none; border-bottom: 2px solid #ddd;
        text-align: center; padding: 5px; font-size: 16px; font-weight: bold;
        color: var(--accent); outline: none; background: transparent;
        transition: border-color 0.2s;
    }
    .dict-input:focus { border-color: var(--accent); }

    /* --- ADDED: INITIAL LOADING OVERLAY --- */
    #initial-loading-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(250, 240, 213, 0.95);
        backdrop-filter: blur(15px);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
    }
    #initial-loading-overlay.fade-out {
        opacity: 0;
        pointer-events: none;
    }
    .loading-logo {
        width: 120px;
        animation: pulse-logo 1.5s infinite ease-in-out;
        margin-bottom: 20px;
    }
    .loading-bar {
        width: 200px;
        height: 4px;
        background: #F2CE84;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }
    .loading-bar::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 30%;
        background: #9A0A13;
        animation: loading-slide 1s infinite linear;
        border-radius: 4px;
    }
    @keyframes pulse-logo {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    @keyframes loading-slide {
        0% { left: -30%; }
        100% { left: 100%; }
    }
  </style>
</head>
<body>
  
  <div id="initial-loading-overlay">
      <img src="logo.png" alt="Loading" class="loading-logo">
      <div class="loading-bar"></div>
      <p style="margin-top: 15px; font-weight: 700; color: #711000; font-size: 0.9rem; letter-spacing: 1px;">ƒêANG T·∫¢I D·ªÆ LI·ªÜU...</p>
  </div>

  <!-- Tet Decor Layer (Behind Everything) -->
  <div id="tet-decor-layer" aria-hidden="true">
      <!-- C√†nh ƒê√†o (Tr√°i) - SVG Vector (Thay th·∫ø b·∫±ng th·∫ª <img> n·∫øu mu·ªën d√πng ·∫£nh th·∫≠t) -->
      <img src=".png" class="tet-branch-svg left" alt="C√†nh ƒë√†o">
          <path d="M0,0 Q80,20 120,80 Q140,110 130,150" fill="none" stroke="#5d4037" stroke-width="3" />
          <path d="M40,20 Q60,40 50,60" fill="none" stroke="#5d4037" stroke-width="2" />
          <path d="M80,40 Q100,50 110,30" fill="none" stroke="#5d4037" stroke-width="2" />
          <circle cx="50" cy="60" r="5" fill="#ff80ab" />
          <circle cx="120" cy="80" r="6" fill="#ff4081" />
          <circle cx="130" cy="150" r="5" fill="#f50057" />
          <circle cx="110" cy="30" r="4" fill="#ff80ab" />
          <circle cx="20" cy="10" r="4" fill="#ff4081" />
          <circle cx="90" cy="50" r="3" fill="#f50057" />
          <circle cx="100" cy="90" r="3" fill="#ff80ab" />
          <circle cx="140" cy="120" r="4" fill="#ff4081" />
      </svg>

      <!-- C√†nh Mai (Ph·∫£i) - SVG Vector -->
      <img src="mai.png" class="tet-branch-svg right" alt="C√†nh mai">
          <path d="M0,0 Q80,20 120,80 Q140,110 130,150" fill="none" stroke="#5d4037" stroke-width="3" />
          <path d="M40,20 Q60,40 50,60" fill="none" stroke="#5d4037" stroke-width="2" />
          <path d="M80,40 Q100,50 110,30" fill="none" stroke="#5d4037" stroke-width="2" />
          <circle cx="50" cy="60" r="5" fill="#ffeb3b" />
          <circle cx="120" cy="80" r="6" fill="#fbc02d" />
          <circle cx="130" cy="150" r="5" fill="#ffeb3b" />
          <circle cx="110" cy="30" r="4" fill="#fdd835" />
          <circle cx="20" cy="10" r="4" fill="#fbc02d" />
          <circle cx="90" cy="50" r="3" fill="#fff176" />
          <circle cx="100" cy="90" r="3" fill="#fbc02d" />
          <circle cx="140" cy="120" r="4" fill="#fdd835" />
      </svg>
      
      <!-- Container Hoa R∆°i -->
      <div id="fallingFlowersContainer"></div>
  </div>

  <input type="file" id="fileInput" accept=".xlsx" style="display:none;">

  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-bubble">
          <div class="logo-placeholder">
            <img src="logo.png" alt="Logo">
          </div>
        </div>
        <nav class="nav">
          <a class="nav-item active" data-view="lookup" data-i18n="navLookup">Tra t·ª´</a>
          <a class="nav-item" data-view="library" data-i18n="navLibrary">Kho t·ª´ v·ª±ng</a>
          <a class="nav-item" data-view="stats" data-i18n="navStats">Th·ªëng k√™</a>
          <a class="nav-item" data-view="community">Kh√°m ph√°</a>
        </nav>
      </div>
      <div class="top-actions">
        <div class="streak-header">
          <i class="fa-solid fa-fire"></i>
          <span id="headerStreakCount">0</span>
        </div>
        <div class="lang-container">
          <div class="lang" id="langToggle">
            <span id="currentLangDisplay">Ti·∫øng Vi·ªát</span>
            <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i>
          </div>
          <div class="lang-dropdown" id="langDropdown">
            <div class="lang-option" data-lang="vi">Ti·∫øng Vi·ªát</div>
            <div class="lang-option" data-lang="en">English</div>
          </div>
        </div>
        <div class="user">Admin</div>
      </div>
    </div>
  </header>

  <main class="container">

    <section id="lookupSection" class="view-section active">
      <h1 class="page-title">
        <span data-i18n="lookupTitle">Tra c·ª©u & Nh·∫≠p li·ªáu</span>
        <button id="openGuideBtn" class="link-btn" title="H∆∞·ªõng d·∫´n"><i class="fa-solid fa-circle-info"></i></button>
        <button id="openImport" class="link-btn" title="Import Excel"><i class="fa-solid fa-file-arrow-up"></i></button>
      </h1>

      <section class="card ai-card">
        <h2 class="card-title"><i class="fa-solid fa-robot"></i> <span data-i18n="aiCardTitle">Tra t·ª´ v·ª±ng b·∫±ng AI</span></h2>
        <form id="aiForm" class="ai-form" onsubmit="return false;">
          <div class="row">
            <label><span data-i18n="labelWord">T·ª´ v·ª±ng</span><input id="word" type="text" data-i18n-placeholder="phWord" placeholder="Nh·∫≠p t·ª´..." /></label>
            <label><span data-i18n="labelIpa">Phi√™n √¢m (IPA)</span><input id="ipa" type="text" data-i18n-placeholder="phIpa" placeholder="/.../" /></label>
            <label><span data-i18n="labelPos">T·ª´ lo·∫°i</span>
              <select id="pos">
                <option value="Noun">Noun</option><option value="Verb">Verb</option>
                <option value="Adjective">Adjective</option><option value="Adverb">Adverb</option>
              </select>
            </label>
          </div>
          <div class="row">
            <label><span data-i18n="labelVn">Nghƒ©a Ti·∫øng Vi·ªát</span><input id="vn" type="text" data-i18n-placeholder="phVn" placeholder="Nghƒ©a..." /></label>
            <label><span data-i18n="labelTopic">Ch·ªß ƒë·ªÅ</span><input id="topic" type="text" data-i18n-placeholder="phTopic" placeholder="Ch·ªß ƒë·ªÅ..." /></label>
          </div>
          <div class="row">
            <label><span data-i18n="labelEng">Gi·∫£i th√≠ch (Anh)</span><input id="engExplain" type="text" data-i18n-placeholder="phEng" placeholder="Definition..." /></label>
            <label><span data-i18n="labelExample">V√≠ d·ª•</span><input id="example" type="text" data-i18n-placeholder="phExample" placeholder="Sentence..." /></label>
          </div>
          <div class="row">
            <label><span data-i18n="labelSyn">T·ª´ ƒë·ªìng nghƒ©a</span><input id="synonyms" type="text" data-i18n-placeholder="phList" placeholder="syn1, syn2..." /></label>
            <label><span data-i18n="labelAnt">T·ª´ tr√°i nghƒ©a</span><input id="antonyms" type="text" data-i18n-placeholder="phList" placeholder="ant1, ant2..." /></label>
          </div>
          <div class="form-actions">
            <button id="aiLookup" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btnAi">TRA T·ª™ B·∫∞NG AI</span></button>
            <button id="addWordBtn" class="btn btn-ghost"><i class="fa-solid fa-plus"></i> <span data-i18n="btnAdd">TH√äM V√ÄO KHO</span></button>
          </div>
        </form>
      </section>

      <section class="card">
        <h2 class="card-title" data-i18n="listTitle">Danh s√°ch t·ª´ v·ª±ng ƒë√£ l∆∞u</h2>
        <div class="table-wrap">
          <table id="vocabTable">
            <thead>
              <tr>
                <th data-i18n="thWord">T·ª´ v·ª±ng</th>
                <th data-i18n="thIpa">IPA</th>
                <th data-i18n="thType">Lo·∫°i</th>
                <th data-i18n="thMeaning">Nghƒ©a Vi·ªát</th>
                <th data-i18n="thDesc">Gi·∫£i th√≠ch</th>
                <th data-i18n="thExample">V√≠ d·ª•</th>
                <th data-i18n="thSyn">ƒê·ªìng nghƒ©a</th>
                <th>Tr√°i nghƒ©a</th>
                <th data-i18n="thAction">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

    <section id="librarySection" class="view-section">
      <h1 class="page-title" data-i18n="libraryPageTitle">Kho t·ª´ v·ª±ng</h1>
      
      <div class="lib-controls">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="libSearchInput" placeholder="T√¨m ki·∫øm th∆∞ m·ª•c ch·ªß ƒë·ªÅ..." autocomplete="off">
        </div>
        <!-- Deleted btnExportExcel as requested -->
      </div>

      <div id="topicGrid" class="topic-grid"></div>
    </section>

    <section id="statsSection" class="view-section">
      <div class="glass-stats relative overflow-hidden">
        <div class="absolute -top-10 -right-10 w-64 h-64 bg-[#F2CE84] rounded-full blur-3xl opacity-20"></div>
        <div class="relative z-10">
          <div class="flex flex-col md:flex-row justify-between mb-10 items-center gap-4">
            <div>
              <h1 class="text-3xl font-extrabold text-[#711000]">Th·ªëng k√™ h·ªçc t·∫≠p üëã</h1>
              <p class="text-[#8c7e6a] font-medium">Theo d√µi ti·∫øn ƒë·ªô v√† m·ªü kh√≥a huy hi·ªáu m·ªõi.</p>
            </div>
            <div class="flex items-center gap-3 bg-[#FAF0D5]/80 p-3 pr-6 rounded-full border border-[#F2CE84]/30">
              <div class="w-12 h-12 rounded-full border-2 border-[#E69739] overflow-hidden bg-white">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Avatar">
              </div>
              <div>
                <p class="text-xs font-bold text-[#E69739] uppercase">Level <span id="userLevel">1</span></p>
                <p class="text-sm font-bold text-[#711000]" id="userRank">Ng∆∞·ªùi M·ªõi</p>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
              <div class="bg-gradient-to-br from-[#9A0A13] to-[#711000] rounded-3xl p-8 text-[#FAF0D5] relative shadow-xl">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-[#F2CE84] font-medium mb-1">Chu·ªói h·ªçc t·∫≠p</p>
                    <div class="flex items-end gap-2">
                      <span class="text-7xl font-black" id="dashStreak">0</span>
                      <span class="text-2xl font-bold mb-2">ng√†y</span>
                    </div>
                  </div>
                  <div class="streak-fire bg-white/10 p-6 rounded-full border border-white/20">
                    <i data-lucide="flame" class="w-16 h-16 text-[#F2CE84] fill-[#F2CE84]"></i>
                  </div>
                </div>
                <p class="mt-4 text-sm opacity-80">T·ªïng c·ªông <span id="totalMem" class="font-bold">0</span> t·ª´ ƒë√£ thu·ªôc.</p>
              </div>

              <div class="bg-white rounded-3xl p-6 border border-[#F2CE84]/20 shadow-sm">
                <h3 class="font-bold text-[#711000] mb-4">L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
                <div class="heatmap-grid" id="heatmapGrid"></div>
              </div>
            </div>
            <div class="space-y-6">
              <div class="bg-[#FAF0D5] rounded-3xl p-6 border border-[#F2CE84]/30">
                <h3 class="font-bold text-[#711000] mb-6 flex items-center gap-2"><i data-lucide="award"></i> Huy hi·ªáu</h3>
                <div class="grid grid-cols-3 gap-4">
                  <div id="badge-speed" class="badge-locked flex flex-col items-center gap-1" title="H·ªçc 7 ng√†y li√™n ti·∫øp">
                    <div class="w-10 h-10 bg-[#F2CE84] rounded-full flex items-center justify-center text-[#9A0A13]"><i data-lucide="zap" class="w-5 h-5 fill-current"></i></div>
                    <span class="text-[9px] font-bold">Si√™u t·ªëc</span>
                  </div>
                  <div id="badge-worm" class="badge-locked flex flex-col items-center gap-1" title="200 t·ª´/ng√†y">
                    <div class="w-10 h-10 bg-[#F2CE84] rounded-full flex items-center justify-center text-[#9A0A13]"><i data-lucide="book-open" class="w-5 h-5 fill-current"></i></div>
                    <span class="text-[9px] font-bold">M·ªçt s√°ch</span>
                  </div>
                  <div id="badge-memory" class="badge-locked flex flex-col items-center gap-1" title="200 t·ª´/4 gi·ªù">
                    <div class="w-10 h-10 bg-[#F2CE84] rounded-full flex items-center justify-center text-[#9A0A13]"><i data-lucide="brain" class="w-5 h-5 fill-current"></i></div>
                    <span class="text-[9px] font-bold">Tr√≠ nh·ªõ</span>
                  </div>
                </div>
              </div>

              <div class="bg-white p-6 rounded-3xl border border-[#F2CE84]/30">
                <p class="text-xs font-bold text-[#711000] mb-2 uppercase">Ti·∫øn ƒë·ªô h√¥m nay</p>
                <div class="w-full bg-[#FAF0D5] h-3 rounded-full overflow-hidden">
                  <div id="todayBar" class="bg-[#9A0A13] h-full transition-all" style="width:0%"></div>
                </div>
                <p class="text-[10px] mt-2 text-[#8c7e6a]">ƒê√£ ghi nh·ªõ <span id="todayCount">0</span> t·ª´ m·ªõi.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="communitySection" class="view-section">
      <h1 class="page-title">
        <span>Kh√°m ph√° & Ti·ªán √≠ch</span>
        <div class="flex gap-2">
            <span class="text-xs bg-[#F2CE84] text-[#711000] px-3 py-1 rounded-full font-bold self-center">Premium Hub</span>
        </div>
      </h1>

      <div class="bento-grid">
        
        <!-- Game Card (Large) -->
        <div class="bento-card span-3 row-span-2 dark-bg">
          <div class="bento-tag tag-hot"><i class="fas fa-fire"></i> Hot Game</div>
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-cloud-showers-heavy"></i></div>
            <div class="disco-title">M∆∞a t·ª´ v·ª±ng</div>
          </div>
          
          <div class="game-controls">
            <button id="startGameBtn" class="bg-[#2e7d32] text-white px-5 py-2 rounded-xl font-bold hover:bg-[#1b5e20] transition shadow-lg flex items-center gap-2"><i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu</button>
            <select id="gameSpeed" class="p-2 border rounded-xl text-sm outline-none text-black bg-white/90 font-medium">
              <option value="30">T·ªëc ƒë·ªô: Nhanh (30s)</option>
              <option value="45" selected>T·ªëc ƒë·ªô: Th∆∞·ªùng (45s)</option>
              <option value="60">T·ªëc ƒë·ªô: Ch·∫≠m (1p)</option>
            </select>
            <div style="flex:1"></div>
            <span class="font-bold text-[#F2CE84] bg-white/10 px-3 py-1 rounded-lg border border-white/20">High Score: <span id="highScoreDisplay">0</span></span>
          </div>
          
          <div class="game-container" id="gameContainer">
            <div class="game-score">Score: <span id="currentScore">0</span></div>
            <div class="game-over-overlay" id="gameOverOverlay">
              <h2 class="text-4xl font-extrabold mb-4 text-[#FF4B4B] tracking-widest">GAME OVER</h2>
              <p class="mb-6 text-white text-lg">ƒêi·ªÉm c·ªßa b·∫°n: <span id="finalScore" class="font-bold text-[#F2CE84] text-3xl ml-2">0</span></p>
              <button onclick="document.getElementById('gameOverOverlay').style.display='none'; document.getElementById('startGameBtn').click()" class="bg-[#F2CE84] text-[#711000] px-8 py-3 rounded-xl font-bold hover:scale-105 transition shadow-xl uppercase">Ch∆°i l·∫°i</button>
            </div>
            <!-- Input floated at bottom -->
            <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 80%; z-index: 15;">
              <input type="text" id="gameInput" class="w-full p-3 rounded-xl bg-white/95 text-[#711000] font-bold outline-none text-center shadow-lg border-2 border-transparent focus:border-[#F2CE84] text-lg placeholder-gray-400" placeholder="Nh·∫≠p t·ª´ ti·∫øng Anh r·ªìi nh·∫•n Enter..." autocomplete="off">
            </div>
          </div>
        </div>

        <!-- Daily Challenge (Sidebar) -->
        <div class="bento-card span-1 row-span-2">
           <div class="bento-tag tag-new">H√¥m nay</div>
           <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="disco-title text-sm">Th·ª≠ th√°ch ng√†y</div>
          </div>
          <div id="dailyChallengeList" class="flex flex-col gap-3 h-full">
            <div class="dc-item" onclick="this.classList.toggle('completed')">
              <div class="dc-check"><i class="fas fa-check"></i></div>
              <div class="dc-text">Ghi nh·ªõ 50 t·ª´ v·ª±ng</div>
            </div>
            <div class="dc-item" onclick="this.classList.toggle('completed')">
              <div class="dc-check"><i class="fas fa-check"></i></div>
              <div class="dc-text">√în t·∫≠p l·∫°i t·ª´ c≈©</div>
            </div>
            <div class="dc-item" onclick="this.classList.toggle('completed')">
              <div class="dc-check"><i class="fas fa-check"></i></div>
              <div class="dc-text">Vi·∫øt 5 c√¢u v√≠ d·ª•</div>
            </div>
            <div class="dc-item" onclick="this.classList.toggle('completed')">
              <div class="dc-check"><i class="fas fa-check"></i></div>
              <div class="dc-text">Nghe ch√©p 10 t·ª´</div>
            </div>
            <div class="mt-auto pt-6 text-center border-t border-dashed border-gray-200">
                 <div class="w-16 h-16 bg-[#fffbeb] rounded-full flex items-center justify-center mx-auto mb-3 border border-[#fde68a] shadow-sm">
                     <i class="fas fa-trophy text-[#E69739] text-2xl"></i>
                 </div>
                 <p class="text-xs text-gray-400 italic font-medium">Ho√†n th√†nh ƒë·ªÉ nh·∫≠n huy hi·ªáu l·ª≠a!</p>
            </div>
          </div>
        </div>

        <!-- Roleplay Section -->
        <div class="bento-card span-2 row-span-2">
          <div class="bento-tag tag-pro">AI Speaking</div>
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-masks-theater"></i></div>
            <div class="disco-title">Gi·∫£ l·∫≠p h·ªôi tho·∫°i</div>
          </div>
          
          <div class="flex flex-col gap-3 mb-3">
            <select id="roleplayScenario" class="w-full p-3 border border-[#e5e7eb] rounded-xl text-sm bg-[#f9fafb] outline-none font-bold text-[#374151] hover:border-[#d1d5db] transition">
              <option value="barista">‚òï Order C√† ph√™</option>
              <option value="hotel">üè® Check-in Kh√°ch s·∫°n</option>
              <option value="interview">üíº Ph·ªèng v·∫•n xin vi·ªác</option>
              <option value="friend">üëã Tr√≤ chuy·ªán b·∫°n b√®</option>
              <option value="shopping">üõçÔ∏è Mua s·∫Øm qu·∫ßn √°o</option>
              <option value="doctor">ü©∫ Kh√°m b√°c sƒ©</option>
              <option value="airport">‚úàÔ∏è T·∫°i s√¢n bay</option>
              <option value="custom">‚ú® -- T·ª± nh·∫≠p ch·ªß ƒë·ªÅ --</option>
            </select>
            <input id="roleplayCustomInput" type="text" class="hidden w-full p-3 border border-[#E69739] rounded-xl text-sm outline-none bg-white shadow-inner" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ b·∫°n mu·ªën (VD: ƒê√†m ph√°n l∆∞∆°ng)...">
          </div>

          <div id="roleplayChat" class="rp-chat shadow-inner">
            <div class="rp-bubble rp-ai" data-en="Hello! Let's start the conversation." data-vi="Xin ch√†o! H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán n√†o." data-lang="en" onclick="toggleRpLang(this)">Hello! Let's start the conversation.</div>
          </div>
          <div class="flex gap-2 mt-3">
            <input id="roleplayInput" type="text" class="flex-1 p-3 border border-gray-200 rounded-xl text-sm outline-none focus:border-[#711000] focus:shadow-sm transition" placeholder="Reply in English...">
            <button id="roleplaySend" class="bg-[#9A0A13] text-white w-12 h-auto rounded-xl shadow-md hover:bg-[#711000] transition flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>

        <!-- Creative Workshop -->
        <div class="bento-card span-2 row-span-2">
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-pen-nib"></i></div>
            <div class="disco-title">X∆∞·ªüng S√°ng T·∫°o</div>
          </div>
          
          <div class="flex justify-between items-center mb-3 bg-gray-50 p-2 rounded-lg">
            <span class="text-[11px] font-bold text-gray-500 uppercase tracking-wide">T·ª´ v·ª±ng g·ª£i √Ω:</span>
            <button id="btnSuggestWords" class="text-[10px] bg-[#FAF0D5] text-[#E69739] px-3 py-1.5 rounded-md hover:bg-[#F2CE84] transition font-bold shadow-sm"><i class="fas fa-lightbulb"></i> L·∫•y t·ª´ ƒë√£ h·ªçc</button>
          </div>
          <div id="suggestedWordsArea" class="flex flex-wrap gap-2 mb-3 min-h-[24px]">
            <span class="text-[11px] text-gray-300 italic pl-2">Nh·∫•n n√∫t ƒë·ªÉ l·∫•y g·ª£i √Ω...</span>
          </div>

          <textarea id="creativeInput" class="cw-textarea flex-1" placeholder="Vi·∫øt ƒëo·∫°n vƒÉn s·ª≠ d·ª•ng t·ª´ m·ªõi, AI s·∫Ω s·ª≠a l·ªói ng·ªØ ph√°p cho b·∫°n..."></textarea>
          <button id="btnCreativeFix" class="full-w-btn shadow-md py-3 text-sm"><i class="fas fa-magic"></i> S·ª≠a l·ªói & G·ª£i √Ω</button>
          <div id="creativeResult" class="cw-result mt-3 shadow-sm"></div>
        </div>

        <!-- Mini Tool: Dictation -->
        <div class="bento-card span-2">
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-headphones"></i></div>
            <div class="disco-title text-sm">Nghe ch√©p</div>
          </div>
          <div class="dict-box py-2 flex flex-col items-center">
            <button id="dictationBtn" class="w-14 h-14 rounded-full bg-[#FAF0D5] text-[#9A0A13] text-2xl hover:scale-110 transition shadow-md flex items-center justify-center mb-3 border-2 border-[#fff]"><i class="fas fa-volume-high"></i></button>
            <input id="dictationInput" type="text" class="dict-input text-lg mb-2" placeholder="Nh·∫≠p t·ª´..." autocomplete="off">
            <div id="dictationCheck" class="dict-status text-[11px] text-gray-400 font-medium">Nghe v√† ƒëi·ªÅn t·ª´</div>
          </div>
          <div class="flex gap-2 mt-auto pt-2">
            <button id="dictationSkip" class="full-w-btn ghost-btn py-2 text-xs rounded-lg">B·ªè qua</button>
            <button id="dictationSubmit" class="full-w-btn py-2 text-xs rounded-lg bg-green-700 hover:bg-green-800">Check</button>
          </div>
        </div>

        <!-- Mini Tool: Network -->
        <div class="bento-card span-2">
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-project-diagram"></i></div>
            <div class="disco-title text-sm">M·∫°ng l∆∞·ªõi</div>
          </div>
          <div class="flex gap-2 mb-3">
            <input id="netInput" type="text" class="flex-1 p-2 border border-[#D9C5A0] rounded-lg outline-none text-xs bg-gray-50 focus:bg-white" placeholder="T·ª´ g·ªëc...">
            <button id="netBtn" class="bg-[#9A0A13] text-white px-3 rounded-lg font-bold text-xs hover:bg-[#711000]"><i class="fas fa-arrow-right"></i></button>
          </div>
          <div id="netVisual" class="net-canvas h-[140px] border-2 border-dashed border-gray-100 shadow-inner bg-white">
            <p class="text-gray-300 text-[10px]">Mindmap...</p>
          </div>
        </div>

        <!-- Mini Tool: AI Chat -->
        <div class="bento-card span-2">
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-robot"></i></div>
            <div class="disco-title text-sm">Tr·ª£ l√Ω AI</div>
          </div>
          <div id="aiChatBox" class="ai-chat-container p-3 bg-[#f8fafc] rounded-xl mb-3 border border-gray-100 overflow-y-auto shadow-inner" style="height: 120px;">
             <p class="text-center text-[10px] text-gray-400 mt-8">H·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ ti·∫øng Anh...</p>
          </div>
          <div class="flex gap-2 mt-auto">
            <input id="aiChatInput" type="text" class="flex-1 p-2.5 border border-[#e2e8f0] rounded-xl outline-none text-xs" placeholder="H·ªèi AI...">
            <button id="sendAiChat" class="bg-[#711000] text-white w-9 rounded-xl text-xs hover:bg-[#5a0d00]"><i class="fas fa-arrow-up"></i></button>
          </div>
        </div>

        <!-- Mini Tool: Feedback -->
        <div class="bento-card span-2">
          <div class="disco-header">
            <div class="disco-icon"><i class="fas fa-envelope-open-text"></i></div>
            <div class="disco-title text-sm">G√≥p √Ω</div>
          </div>
          <div class="flex space-x-2 mb-3 justify-center" id="feedbackStars">
            <button class="text-gray-300 hover:text-yellow-400 transition text-lg" data-index="1"><i class="fas fa-star"></i></button>
            <button class="text-gray-300 hover:text-yellow-400 transition text-lg" data-index="2"><i class="fas fa-star"></i></button>
            <button class="text-gray-300 hover:text-yellow-400 transition text-lg" data-index="3"><i class="fas fa-star"></i></button>
            <button class="text-gray-300 hover:text-yellow-400 transition text-lg" data-index="4"><i class="fas fa-star"></i></button>
            <button class="text-gray-300 hover:text-yellow-400 transition text-lg" data-index="5"><i class="fas fa-star"></i></button>
          </div>
          <textarea id="feedbackText" placeholder="√ù ki·∫øn c·ªßa b·∫°n..." class="w-full text-xs p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none h-[70px] resize-none mb-2 focus:bg-white transition"></textarea>
          <button id="submitFeedback" class="full-w-btn py-2 text-xs rounded-lg font-bold">G·ª≠i ƒë√°nh gi√°</button>
          
          <div class="mt-3 text-[10px] text-gray-500 text-center leading-relaxed">
            <p class="text-red-600 font-bold mb-1">*T√≠nh nƒÉng ƒëang l·ªói!</p>
            <p>‚ú® N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ g√≥p √Ω, ph·∫£n h·ªìi ho·∫∑c l·ªùi nh·∫Øn n√†o d√†nh cho ch√∫ng t√¥i, vui l√≤ng quay l·∫°i m·ª•c ‚ÄòLi√™n h·ªá ch√∫ng t√¥i‚Äô t·∫°i giao di·ªán tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i th√¥ng tin. Ch√∫ng t√¥i lu√¥n tr√¢n tr·ªçng m·ªçi √Ω ki·∫øn ƒë√≥ng g√≥p nh·∫±m kh√¥ng ng·ª´ng c·∫£i thi·ªán v√† n√¢ng cao ch·∫•t l∆∞·ª£ng h·ªá th·ªëng.</p>
          </div>
        </div>

      </div>

      <div id="communityFeed" style="display:none"></div>
      <div id="challengeList" style="display:none"></div>
      <div id="groupList" style="display:none"></div>
      <div id="statStreak" style="display:none"></div>
      <div id="statContributed" style="display:none"></div>
      <div id="statJoinedGroups" style="display:none"></div>
      <div id="statJoinedChallenges" style="display:none"></div>
    </section>
  </main>

  <div class="modal" id="guideModal" aria-hidden="true">
    <div class="modal-panel large">
      <button class="modal-close" onclick="document.getElementById('guideModal').setAttribute('aria-hidden','true')">‚úï</button>
      <h2 style="color: var(--accent); margin-top: 0;" data-i18n="guideTitle">H∆∞·ªõng d·∫´n & ƒê·ªãnh d·∫°ng Import</h2>
      <p>ƒê·ªÉ import th√†nh c√¥ng, file Excel c·ªßa b·∫°n n√™n c√≥ c√°c c·ªôt: <strong>T·ª´ v·ª±ng | IPA | Lo·∫°i | Nghƒ©a Vi·ªát | Ch·ªß ƒë·ªÅ | Gi·∫£i th√≠ch Anh | V√≠ d·ª• | ƒê·ªìng nghƒ©a | Tr√°i nghƒ©a</strong>.</p>

      <div class="excel-guide-wrapper">
        <div class="excel-top-bar">Example.xlsx - VocabAI Theme</div>
        <div class="excel-menu"><span>File</span><span class="active">Home</span><span>Insert</span><span>Data</span><span>View</span></div>
        <div class="formula-bar">
          <div class="name-box" id="guideCellName">A2</div>
          <div class="fx-icon">fx</div>
          <div class="formula-input" id="formulaDisplay">Knowledge</div>
        </div>
        <div class="excel-sheet-container">
          <table class="excel-table">
            <thead>
              <tr><th class="row-index"></th><th style="width:120px">A</th><th style="width:100px">B</th><th style="width:70px">C</th><th style="width:150px">D</th><th style="width:100px">E</th><th style="width:250px">F</th><th style="width:250px">G</th></tr>
              <tr><td class="row-index">1</td><td class="col-header">T·ª´ v·ª±ng</td><td class="col-header">IPA</td><td class="col-header">Lo·∫°i</td><td class="col-header">Nghƒ©a Vi·ªát</td><td class="col-header">Ch·ªß ƒë·ªÅ</td><td class="col-header">Gi·∫£i th√≠ch Anh</td><td class="col-header">V√≠ d·ª•</td></tr>
            </thead>
            <tbody id="guideTableBody">
              <tr onclick="window.updateGuideFormula('Knowledge','A2',this)">
                <td class="row-index">2</td><td style="font-weight:bold">Knowledge</td><td>/Ààn…íl…™d í/</td><td>Noun</td><td>Ki·∫øn th·ª©c</td><td>Education</td><td>Facts, information, and skills...</td><td>Knowledge is power.</td>
              </tr>
              <tr onclick="window.updateGuideFormula('Scholarship','A3',this)">
                <td class="row-index">3</td><td style="font-weight:bold">Scholarship</td><td>/Ààsk…íl…ô É…™p/</td><td>Noun</td><td>H·ªçc b·ªïng</td><td>Education</td><td>Financial aid awarded...</td><td>She won a scholarship.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="excel-sheet-tabs"><div class="excel-tab">Vocabulary</div></div>
        <div class="excel-status-bar">Ready ‚Ä¢ Theme Applied ‚Ä¢ Count: 2</div>
      </div>
    </div>
  </div>

  <div class="modal" id="flashcardModal" aria-hidden="true">
    <div class="modal-panel text-center">
      <button class="modal-close" onclick="document.getElementById('flashcardModal').setAttribute('aria-hidden','true')">‚úï</button>
      <h3 id="fcTopicTitle" class="text-xs uppercase tracking-widest text-[#8c7e6a] mb-2">Topic</h3>
      <div class="flashcard-container" id="fcContainer">
        <div class="flashcard" id="flashcard">
          <div class="flashcard-front">
            <div id="fcWord" class="fc-word">Word</div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
              <div id="fcIpa" class="text-sm text-[#8c7e6a]">/ipa/</div>
              <span id="fcPos" class="tag tag-blue" style="margin-bottom:0;font-size:10px;">NOUN</span>
            </div>
            <button class="icon-btn play mt-4" id="fcSpeak"><i class="fa-solid fa-volume-high"></i></button>
          </div>
          <div class="flashcard-back">
            <div id="fcMeaning" class="fc-meaning">Nghƒ©a</div>
            <div id="fcExample" class="text-sm italic mt-2">Example</div>
          </div>
        </div>
      </div>
      <div class="fc-progress"><div id="fcProgressFill" class="fc-progress-fill"></div></div>
      <div id="fcProgressText" class="text-xs font-bold mt-2">1 / 10</div>
      <div class="flex justify-center gap-4 mt-6">
        <button class="icon-btn" id="fcPrev"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="btn btn-primary px-8" id="fcFlipBtn"><i class="fa-solid fa-rotate"></i> <span data-i18n="btnFlip">L·∫≠t</span></button>
        <button class="icon-btn" id="fcNext"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
    </div>
  </div>

  <div class="modal" id="topicModal" aria-hidden="true">
    <div class="modal-panel large">
      <button class="modal-close" onclick="document.getElementById('topicModal').setAttribute('aria-hidden','true')">‚úï</button>
      <h2 id="modalTopicTitle" class="text-2xl font-bold text-[#711000] mb-4"></h2>
      <div class="table-wrap">
        <table id="topicDetailTable">
          <thead><tr><th>T·ª´ v·ª±ng</th><th>IPA</th><th>Lo·∫°i</th><th>Nghƒ©a Vi·ªát</th><th>V√≠ d·ª•</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="flex justify-center gap-4 mt-6">
        <button id="startFlashcardBtn" class="btn btn-outline" data-i18n="btnFlashcard">Flashcard</button>
        <button id="startReviewBtn" class="btn btn-primary" data-i18n="btnReview">√în t·∫≠p</button>
      </div>
    </div>
  </div>

  <div class="modal" id="reviewModal" aria-hidden="true">
    <div style="width:100%;max-width:850px;padding:20px;">
      <button class="modal-close" style="top:30px;right:30px;z-index:210;" onclick="document.getElementById('reviewModal').setAttribute('aria-hidden','true')">‚úï</button>
      <div id="reviewContentArea"></div>
    </div>
  </div>
  
  <!-- New Share Modal -->
  <div class="modal" id="shareTopicModal" aria-hidden="true">
    <div class="modal-panel">
        <button class="modal-close" onclick="document.getElementById('shareTopicModal').setAttribute('aria-hidden','true')">‚úï</button>
        <h2 style="color: var(--accent); margin-top: 0; display:flex; gap:10px; align-items:center;">
            <i class="fas fa-share-nodes"></i> Chia s·∫ª list t·ª´ v·ª±ng
        </h2>
        <div style="margin-top:20px;">
            <h3 style="color: var(--primary-dark); font-size:16px; font-weight:bold; margin-bottom:10px;">C√°ch chia s·∫ª b·ªô t·ª´ v·ª±ng:</h3>
            <ul style="list-style-type:disc; margin-left:20px; color:#555; line-height:1.6; font-size:14px;">
                <li>T·∫£i file Excel xu·ªëng.</li>
                <li>G·ª≠i file cho b·∫°n b√®.</li>
                <li>Ng∆∞·ªùi nh·∫≠n t·∫£i file l√™n t·∫°i m·ª•c <strong>"Tra c·ª©u & Nh·∫≠p li·ªáu"</strong> ‚Üí ph·∫ßn <strong>"Tra c·ª©u"</strong>.</li>
            </ul>
        </div>
        <div style="margin-top:25px; text-align:center;">
            <button id="btnDownloadExcel" class="btn btn-primary" style="width:100%;">
                <i class="fas fa-file-arrow-down"></i> T·∫¢I FILE EXCEL
            </button>
        </div>
    </div>
  </div>

  <div id="notification"></div>

  <div class="modal" id="shareModal" aria-hidden="true"><div class="modal-panel"><button class="modal-close">‚úï</button></div></div>
  <div class="modal" id="challengeModal" aria-hidden="true"><div class="modal-panel"><button class="modal-close">‚úï</button></div></div>
  <div class="modal" id="challengeDetailModal" aria-hidden="true"><div class="modal-panel"><button class="modal-close">‚úï</button></div></div>
  <div class="modal" id="createGroupModal" aria-hidden="true"><div class="modal-panel"><button class="modal-close">‚úï</button></div></div>
  <div class="modal" id="groupChatModal" aria-hidden="true">
    <div class="modal-panel"><button class="modal-close">‚úï</button>
    <div id="chatGroupName"></div><div id="pinnedTopicName"></div><div id="groupChatHistory"></div>
    <div id="sidebarPollArea"></div><button id="viewPinnedWords"></button><button id="savePinnedToLib"></button>
    <input id="groupChatInput"><button id="sendGroupChat"></button>
    </div>
  </div>

  <script>
      window.addEventListener('load', () => {
          const overlay = document.getElementById('initial-loading-overlay');
          setTimeout(() => {
              overlay.classList.add('fade-out');
              setTimeout(() => {
                  overlay.remove();
              }, 500);
          }, 800);
      });
  </script>

  <!-- Script for Falling Flowers Effect (Using IMAGES) -->
  <script>
    (function() {
        const container = document.getElementById('fallingFlowersContainer');
        
        // DANH S√ÅCH ·∫¢NH HOA R∆†I (B·∫†N C√ì TH·ªÇ THAY LINK ·∫¢NH T·∫†I ƒê√ÇY)
        const flowerImages = [
            "daoroi.png", 
            "mairoi.png",
        ];
        
        function createFlower() {
            const flower = document.createElement('img');
            // Ch·ªçn ng·∫´u nhi√™n 1 ·∫£nh t·ª´ danh s√°ch
            const randomSrc = flowerImages[Math.floor(Math.random() * flowerImages.length)];
            
            flower.src = randomSrc;
            flower.className = 'falling-flower';
            
            // Random v·ªã tr√≠ v√† k√≠ch th∆∞·ªõc
            flower.style.left = Math.random() * 100 + 'vw';
            
            const size = Math.random() * 15 + 15; // K√≠ch th∆∞·ªõc t·ª´ 15px ƒë·∫øn 30px
            flower.style.width = size + 'px';
            flower.style.height = size + 'px';
            
            // Random th·ªùi gian r∆°i
            const duration = Math.random() * 5 + 8; // 8s ƒë·∫øn 13s
            flower.style.animation = `flower-fall ${duration}s linear infinite`;
            flower.style.opacity = Math.random() * 0.5 + 0.5;
            
            container.appendChild(flower);
            
            // T·ª± x√≥a sau khi r∆°i xong ƒë·ªÉ tr√°nh n·∫∑ng m√°y
            setTimeout(() => {
                flower.remove();
            }, duration * 1000);
        }

        // T·∫°o hoa m·ªõi m·ªói 500ms
        setInterval(createFlower, 500); 
    })();
  </script>

  <script>
    (()=>{
      /* =========================
         STATE & STORAGE (core)
         ========================= */
      const apiKey = "AIzaSyBCtEY3yXq0F6g6myRILkICv4OhlHiIpEA"; // gi·ªØ nguy√™n
      let vocab = JSON.parse(localStorage.getItem('vocab_v2') || '[]');
      let stats = JSON.parse(localStorage.getItem('vocab_stats_v3') || JSON.stringify({ streak: 0, lastDate: null, history: {}, logs: [] }));
      let currentLang = localStorage.getItem('vocab_lang') || 'vi';
      let editingIndex = -1;

      const translations = {
        vi:{navLookup:"Tra t·ª´",navLibrary:"Kho t·ª´ v·ª±ng",navStats:"Th·ªëng k√™",
          lookupTitle:"Tra c·ª©u & Nh·∫≠p li·ªáu",aiCardTitle:"Tra t·ª´ v·ª±ng b·∫±ng AI",
          labelWord:"T·ª´ v·ª±ng",labelIpa:"Phi√™n √¢m (IPA)",labelPos:"T·ª´ lo·∫°i",
          labelVn:"Nghƒ©a Ti·∫øng Vi·ªát",labelTopic:"Ch·ªß ƒë·ªÅ",labelEng:"Gi·∫£i th√≠ch (Anh)",
          labelExample:"V√≠ d·ª•",labelSyn:"T·ª´ ƒë·ªìng nghƒ©a",labelAnt:"T·ª´ tr√°i nghƒ©a",
          phWord:"Nh·∫≠p t·ª´...",phIpa:"/.../",phVn:"Nghƒ©a...",
          phTopic:"Ch·ªß ƒë·ªÅ...",phEng:"Definition...",phExample:"Sentence...",
          phList:"syn1, syn2...",btnAi:"TRA T·ª™ B·∫∞NG AI",btnAdd:"TH√äM V√ÄO KHO",
          btnUpdate:"C·∫¨P NH·∫¨T",listTitle:"Danh s√°ch t·ª´ v·ª±ng ƒë√£ l∆∞u",
          thWord:"T·ª´ v·ª±ng",thIpa:"IPA",thType:"Lo·∫°i",thMeaning:"Nghƒ©a Vi·ªát",
          thDesc:"Gi·∫£i th√≠ch",thExample:"V√≠ d·ª•",thSyn:"ƒê·ªìng nghƒ©a",thAction:"H√†nh ƒë·ªông",
          libraryPageTitle:"Kho t·ª´ v·ª±ng",btnFlip:"L·∫≠t",btnFlashcard:"Flashcard",btnReview:"√în t·∫≠p",
          tagVn:"NGHƒ®A TI·∫æNG VI·ªÜT",tagHint:"G·ª¢I √ù",btnShowAns:"HI·ªÜN ƒê√ÅP √ÅN",
          srsAgain:"L·∫°i",srsHard:"Kh√≥",srsGood:"ƒê∆∞·ª£c",srsEasy:"D·ªÖ",
          tagTarget:"T·ª™ V·ª∞NG M·ª§C TI√äU",guideTitle:"H∆∞·ªõng d·∫´n & ƒê·ªãnh d·∫°ng Import"},
        en:{navLookup:"Lookup",navLibrary:"Library",navStats:"Stats",
          lookupTitle:"Lookup & Entry",aiCardTitle:"AI-Powered Lookup",
          labelWord:"Vocabulary",labelIpa:"IPA",labelPos:"Type",
          labelVn:"VN Meaning",labelTopic:"Topic",labelEng:"Explanation",
          labelExample:"Example",labelSyn:"Synonyms",labelAnt:"Antonyms",
          phWord:"Enter word...",phIpa:"/.../",phVn:"Meaning...",
          phTopic:"Topic...",phEng:"Definition...",phExample:"Sentence...",
          phList:"syn1, syn2...",btnAi:"AI LOOKUP",btnAdd:"ADD TO LIBRARY",
          btnUpdate:"UPDATE",listTitle:"Saved Vocabulary List",
          thWord:"Word",thIpa:"IPA",thType:"Type",thMeaning:"Meaning",
          thDesc:"Explanation",thExample:"Example",thSyn:"Synonyms",thAction:"Action",
          libraryPageTitle:"Vocabulary Library",btnFlip:"Flip",btnFlashcard:"Flashcard",btnReview:"Review",
          tagVn:"VIETNAMESE MEANING",tagHint:"HINT",btnShowAns:"SHOW ANSWER",
          srsAgain:"Again",srsHard:"Hard",srsGood:"Good",srsEasy:"Easy",
          tagTarget:"TARGET VOCABULARY",guideTitle:"Import Guide & Format"}
      };

      const saveCore = ()=>{
        localStorage.setItem('vocab_v2', JSON.stringify(vocab));
        localStorage.setItem('vocab_stats_v3', JSON.stringify(stats));
      };
      const getT = k => (translations[currentLang]||{})[k] || k;
      const escapeHTML = s => s ? String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : '';

      const showMessage = (msg)=>{
        const n = document.getElementById('notification');
        n.textContent = msg; n.style.display = 'block';
        setTimeout(()=> n.style.display = 'none', 2500);
      };

      /* =========================
         STATS & STREAK (gi·ªØ nguy√™n)
         ========================= */
      function updateStreak(){
        const today = new Date().toISOString().split('T')[0];
        if (stats.lastDate && stats.lastDate !== today){
          const last = new Date(stats.lastDate);
          const curr = new Date(today);
          const diff = Math.floor((curr - last) / (1000*60*60*24));
          if (diff === 1) stats.streak += 1;
          else if (diff > 1) stats.streak = 1;
        } else if (!stats.lastDate){
          stats.streak = 1;
        }
        stats.lastDate = today;
        saveCore(); renderStats();
      }
      function logActivity(word){
        const today = new Date().toISOString().split('T')[0];
        const now = Date.now();
        stats.history[today] = (stats.history[today] || 0) + 1;
        stats.logs.push({t: now, w: word});
        const twoDays = 2*24*60*60*1000;
        stats.logs = stats.logs.filter(l => now - l.t < twoDays);
        updateStreak();
      }
      function checkBadges(){
        const today = new Date().toISOString().split('T')[0];
        const now = Date.now();
        if (stats.streak >= 7) document.getElementById('badge-speed')?.classList.add('badge-unlocked');
        if ((stats.history[today] || 0) >= 200) document.getElementById('badge-worm')?.classList.add('badge-unlocked');
        const fourHrs = 4*60*60*1000;
        const recent = stats.logs.filter(l => now - l.t < fourHrs);
        if (recent.length >= 200) document.getElementById('badge-memory')?.classList.add('badge-unlocked');
      }
      function renderStats(){
        const today = new Date().toISOString().split('T')[0];
        const streakEl = document.getElementById('headerStreakCount'); if (streakEl) streakEl.textContent = stats.streak;
        const dashStreak = document.getElementById('dashStreak'); if (dashStreak) dashStreak.textContent = stats.streak;
        const memCount = vocab.filter(v => v.remember).length;
        const totalMem = document.getElementById('totalMem'); if (totalMem) totalMem.textContent = memCount;
        const daily = stats.history[today] || 0;
        const todayCount = document.getElementById('todayCount'); if (todayCount) todayCount.textContent = daily;
        const bar = document.getElementById('todayBar'); if (bar) bar.style.width = Math.min(100, (daily/50)*100) + '%';
        const grid = document.getElementById('heatmapGrid');
        if (grid){
          grid.innerHTML = '';
          for (let i=0;i<140;i++){
            const cell = document.createElement('div');
            cell.className = `heatmap-cell ${i>130 ? 'lvl-'+Math.floor(Math.random()*3) : 'lvl-0'}`;
            grid.appendChild(cell);
          }
        }
        let rank = "Ng∆∞·ªùi M·ªõi", lv = 1;
        if (memCount > 50){ rank = "Ng∆∞·ªùi Ham H·ªçc"; lv = 5; }
        if (memCount > 200){ rank = "M·ªçt S√°ch"; lv = 10; }
        if (memCount > 500){ rank = "H·ªçc Gi·∫£"; lv = 20; }
        const rankEl = document.getElementById('userRank'); if (rankEl) rankEl.textContent = rank;
        const levelEl = document.getElementById('userLevel'); if (levelEl) levelEl.textContent = lv;
        checkBadges();
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // sync sang Community side widget
        const statStreak = document.getElementById('statStreak');
        if (statStreak) statStreak.textContent = `${stats.streak} ng√†y`;
      }

      /* =========================
         VOCAB TABLE & LIBRARY
         ========================= */
      const fields = {
        word: document.getElementById('word'),
        ipa: document.getElementById('ipa'),
        pos: document.getElementById('pos'),
        vn: document.getElementById('vn'),
        topic: document.getElementById('topic'),
        engExplain: document.getElementById('engExplain'),
        example: document.getElementById('example'),
        synonyms: document.getElementById('synonyms'),
        antonyms: document.getElementById('antonyms')
      };

      function updateUILanguage(lang){
        const t = translations[lang];
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const key = el.getAttribute('data-i18n'); if (t[key]) el.textContent = t[key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
          const key = el.getAttribute('data-i18n-placeholder'); if (t[key]) el.placeholder = t[key];
        });
        document.getElementById('currentLangDisplay').textContent = lang==='vi'?'Ti·∫øng Vi·ªát':'English';
      }

      function renderTable(){
        const tbody = document.querySelector('#vocabTable tbody'); if (!tbody) return;
        tbody.innerHTML = vocab.length ? '' : '<tr><td colspan="9" class="text-center py-10 opacity-50 italic">Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o</td></tr>';
        [...vocab].reverse().forEach((item, revIdx)=>{
          const idx = vocab.length - 1 - revIdx;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="font-bold text-[#9A0A13]">${escapeHTML(item.word)}</td>
            <td class="text-xs text-[#8C6D5E]">${escapeHTML(item.ipa)}</td>
            <td><span class="text-[10px] bg-[#F2CE84] px-2 py-0.5 rounded font-bold">${escapeHTML(item.pos)}</span></td>
            <td>${escapeHTML(item.vn)}</td>
            <td class="text-xs max-w-[150px] truncate">${escapeHTML(item.engExplain)}</td>
            <td class="text-xs italic max-w-[150px] truncate">${escapeHTML(item.example)}</td>
            <td class="text-xs">${escapeHTML(Array.isArray(item.synonyms)? item.synonyms.join(', '): item.synonyms)}</td>
            <td class="text-xs">${escapeHTML(Array.isArray(item.antonyms)? item.antonyms.join(', '): item.antonyms)}</td>
            <td>
              <div class="flex gap-2">
                <button class="icon-btn play" onclick="window.speak('${escapeHTML(item.word)}')"><i class="fa-solid fa-volume-high"></i></button>
                <button class="icon-btn rem ${item.remember?'active':''}" data-idx="${idx}"><i class="fa-solid ${item.remember?'fa-circle-check':'fa-circle'}"></i></button>
                <button class="icon-btn edit" data-idx="${idx}"><i class="fa-solid fa-pen"></i></button>
                <button class="icon-btn del" data-idx="${idx}"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      // Updated Render Library to include Menu
      function renderLibrary(filterText = ""){
        const grid = document.getElementById('topicGrid'); if (!grid) return;
        grid.innerHTML = '';
        const groups = vocab.reduce((acc, it)=>{
          const t = it.topic || "Chung";
          if (!acc[t]) acc[t] = []; acc[t].push(it);
          return acc;
        }, {});
        
        Object.entries(groups).forEach(([name, words])=>{
          if(filterText && !name.toLowerCase().includes(filterText.toLowerCase())) return;

          const card = document.createElement('div');
          card.className = 'topic-card';
          
          // Card Content
          const infoDiv = document.createElement('div');
          infoDiv.style.display = 'flex';
          infoDiv.style.gap = '15px';
          infoDiv.innerHTML = `<div class="topic-icon"><i class="fa-solid fa-folder-open"></i></div>
            <div class="topic-info"><h3 class="font-bold">${escapeHTML(name)}</h3>
            <p class="text-xs text-[#8c7e6a]">${words.length} ${currentLang==='vi'?'t·ª´ v·ª±ng':'words'}</p></div>`;
          card.appendChild(infoDiv);

          // Menu Button
          const menuBtn = document.createElement('button');
          menuBtn.className = 'topic-menu-btn';
          menuBtn.innerHTML = '‚ãÆ';
          menuBtn.onclick = (e) => {
              e.stopPropagation();
              // Close other menus first
              document.querySelectorAll('.topic-dropdown.show').forEach(d => {
                  if (d !== dropdown) d.classList.remove('show');
              });
              dropdown.classList.toggle('show');
          };
          card.appendChild(menuBtn);

          // Dropdown
          const dropdown = document.createElement('div');
          dropdown.className = 'topic-dropdown';
          
          // 1. Delete List
          const delBtn = document.createElement('button');
          delBtn.className = 'topic-action delete';
          delBtn.innerHTML = '<i class="fa-solid fa-trash"></i> X√≥a list';
          delBtn.onclick = (e) => {
              e.stopPropagation();
              dropdown.classList.remove('show');
              if(confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªß ƒë·ªÅ "${name}" v√† to√†n b·ªô ${words.length} t·ª´ v·ª±ng trong ƒë√≥?`)) {
                 vocab = vocab.filter(v => (v.topic || "Chung") !== name);
                 saveCore(); renderTable(); renderLibrary(); renderStats();
              }
          };
          dropdown.appendChild(delBtn);

          // 2. Rename Topic
          const renBtn = document.createElement('button');
          renBtn.className = 'topic-action';
          renBtn.innerHTML = '<i class="fa-solid fa-pen"></i> ƒê·ªïi t√™n';
          renBtn.onclick = (e) => {
              e.stopPropagation();
              dropdown.classList.remove('show');
              const newName = prompt("Nh·∫≠p t√™n m·ªõi cho ch·ªß ƒë·ªÅ:", name);
              if(newName && newName.trim() !== "" && newName !== name) {
                  vocab.forEach(v => {
                      if((v.topic || "Chung") === name) v.topic = newName.trim();
                  });
                  saveCore(); renderTable(); renderLibrary(); renderStats();
              }
          };
          dropdown.appendChild(renBtn);

          // 3. Share List
          const shareBtn = document.createElement('button');
          shareBtn.className = 'topic-action';
          shareBtn.innerHTML = '<i class="fa-solid fa-share-nodes"></i> Chia s·∫ª';
          shareBtn.onclick = (e) => {
              e.stopPropagation();
              dropdown.classList.remove('show');
              openShareModal(name, words);
          };
          dropdown.appendChild(shareBtn);

          card.appendChild(dropdown);

          // Card Click Event (Open Details)
          card.onclick = (e)=>{
             // Check if dropdown is open and clicked outside logic handled elsewhere
             document.getElementById('modalTopicTitle').textContent = name;
             renderTopicDetailTable(name, words);
             document.getElementById('startReviewBtn').onclick = ()=>{ document.getElementById('topicModal').setAttribute('aria-hidden','true'); startReview(name, words); };
             document.getElementById('startFlashcardBtn').onclick = ()=>{ document.getElementById('topicModal').setAttribute('aria-hidden','true'); startFlashcards(name, words); };
             document.getElementById('topicModal').setAttribute('aria-hidden','false');
          };
          grid.appendChild(card);
        });
      }

      // Close dropdowns when clicking outside
      window.addEventListener('click', () => {
          document.querySelectorAll('.topic-dropdown.show').forEach(d => d.classList.remove('show'));
      });

      // Handle Share Modal
      function openShareModal(topicName, words) {
          const modal = document.getElementById('shareTopicModal');
          const btnDownload = document.getElementById('btnDownloadExcel');
          
          btnDownload.onclick = () => {
              exportTopicToExcel(topicName, words);
          };
          
          modal.setAttribute('aria-hidden', 'false');
      }

      function exportTopicToExcel(topicName, words) {
          if(!words || words.length === 0) return;

          // Header Row
          const header = ["T·ª´ v·ª±ng", "IPA", "Lo·∫°i", "Nghƒ©a Vi·ªát", "Ch·ªß ƒë·ªÅ", "Gi·∫£i th√≠ch", "V√≠ d·ª•", "ƒê·ªìng nghƒ©a", "Tr√°i nghƒ©a"];
          
          // Data Rows
          const data = words.map(w => [
              w.word,
              w.ipa || "",
              w.pos || "",
              w.vn || "",
              w.topic || "General",
              w.engExplain || "",
              w.example || "",
              Array.isArray(w.synonyms) ? w.synonyms.join(', ') : w.synonyms,
              Array.isArray(w.antonyms) ? w.antonyms.join(', ') : w.antonyms
          ]);

          // Footer Row
          const today = new Date();
          const dateStr = `${today.getDate().toString().padStart(2,0)}/${(today.getMonth()+1).toString().padStart(2,0)}/${today.getFullYear()}`;
          const footer = [`Ng√†y xu·∫•t: ${dateStr} - Xu·∫•t t·ª´ Vocab.AI`];

          // Combine
          const wsData = [header, ...data, [], footer];

          // Create Worksheet
          const ws = XLSX.utils.aoa_to_sheet(wsData);

          // Attempt Formatting (Note: standard sheetjs CDN ignores style objects without pro version, 
          // but strictly following structure requirements)
          // Set column widths
          ws['!cols'] = [
              {wch: 20}, {wch: 15}, {wch: 10}, {wch: 20}, {wch: 15}, {wch: 25}, {wch: 25}, {wch: 20}, {wch: 20}
          ];

          // Create Workbook and Download
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, topicName);
          XLSX.writeFile(wb, `VocabAI_${topicName}.xlsx`);
          
          showMessage("ƒê√£ t·∫£i xu·ªëng file Excel!");
          document.getElementById('shareTopicModal').setAttribute('aria-hidden', 'true');
      }
      
      // NEW: Event Listeners for Library Features
      document.getElementById('libSearchInput').addEventListener('input', (e) => {
        renderLibrary(e.target.value.trim());
      });

      function renderTopicDetailTable(name, words) {
        const tbody = document.querySelector('#topicDetailTable tbody'); tbody.innerHTML = '';
        words.forEach(item=>{
          const tr = document.createElement('tr');
          const oIdx = vocab.indexOf(item);
          tr.innerHTML = `<td>${escapeHTML(item.word)}</td><td>${escapeHTML(item.ipa)}</td>
            <td><span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded">${escapeHTML(item.pos)}</span></td>
            <td>${escapeHTML(item.vn)}</td><td>${escapeHTML(item.example)}</td>
            <td>
              <div class="flex gap-2">
                <button class="icon-btn play" onclick="window.speak('${escapeHTML(item.word)}')"><i class="fa-solid fa-volume-high"></i></button>
                <button class="icon-btn rem ${item.remember?'active text-green-600':''}" data-idx="${oIdx}"><i class="fa-solid ${item.remember?'fa-circle-check':'fa-circle'}"></i></button>
                <button class="icon-btn edit" data-idx="${oIdx}"><i class="fa-solid fa-pen"></i></button>
                <button class="icon-btn del" data-idx="${oIdx}"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      /* =========================
         FLASHCARD & REVIEW (UPDATED SRS Logic)
         ========================= */
      let sessionQueue = []; let currentIdx = 0; let isRevealed = false; let currentUserInput = "";

      function startFlashcards(topic, words){
        sessionQueue = [...words].sort(()=> Math.random()-0.5); currentIdx = 0;
        document.getElementById('fcTopicTitle').textContent = topic;
        updateFCUI();
        document.getElementById('flashcardModal').setAttribute('aria-hidden','false');
      }
      function updateFCUI(){
        const item = sessionQueue[currentIdx];
        document.getElementById('flashcard').classList.remove('flipped');
        document.getElementById('fcWord').textContent = item.word;
        document.getElementById('fcIpa').textContent = item.ipa;
        document.getElementById('fcPos').textContent = (item.pos || 'NOUN').toUpperCase();
        document.getElementById('fcMeaning').textContent = item.vn;
        document.getElementById('fcExample').textContent = item.example;
        document.getElementById('fcProgressText').textContent = `${currentIdx+1} / ${sessionQueue.length}`;
        document.getElementById('fcProgressFill').style.width = ((currentIdx+1)/sessionQueue.length*100)+'%';
        document.getElementById('fcSpeak').onclick = (e)=>{ e.stopPropagation(); window.speak(item.word); };
      }
      document.getElementById('fcFlipBtn').onclick = ()=> document.getElementById('flashcard').classList.toggle('flipped');
      document.getElementById('fcContainer').onclick = ()=> document.getElementById('flashcard').classList.toggle('flipped');
      document.getElementById('fcNext').onclick = ()=>{ if (currentIdx < sessionQueue.length-1){ currentIdx++; updateFCUI(); } };
      document.getElementById('fcPrev').onclick = ()=>{ if (currentIdx > 0){ currentIdx--; updateFCUI(); } };

      function startReview(topic, words){
        sessionQueue = [...words].sort(()=> Math.random()-0.5);
        currentIdx = 0; isRevealed = false; currentUserInput = "";
        renderReviewContent(topic);
        document.getElementById('reviewModal').setAttribute('aria-hidden','false');
      }
      function renderReviewContent(topic){
        const item = sessionQueue[currentIdx];
        const container = document.getElementById('reviewContentArea'); container.innerHTML = "";
        const bc = document.createElement('div'); bc.className = 'review-breadcrumb'; bc.textContent = topic; container.appendChild(bc);
        const card = document.createElement('div'); card.className = 'review-main-card';
        if (!isRevealed){
          card.innerHTML = `
            <div style="width:100%;">
              <span class="tag tag-blue">${getT('tagVn')}</span>
              <div class="translation-vn">${escapeHTML(item.vn)}</div>
              <div class="ipa-block">
                <span>${escapeHTML(item.ipa)}</span>
                <span class="tag tag-blue" style="font-size:10px;margin-bottom:0;">${escapeHTML(item.pos).toUpperCase()}</span>
                <button class="icon-btn play" onclick="window.speak('${escapeHTML(item.word)}')"><i class="fa-solid fa-volume-high"></i></button>
              </div>
            </div>
            <div style="margin:40px 0;text-align:center;width:100%;">
              <span class="tag tag-blue">${getT('tagHint')}</span>
              <div style="font-size:20px;">${escapeHTML((item.example||"").replace(new RegExp(`(${item.word})`,'gi'), "_____"))}</div>
            </div>
            <div style="width:100%;max-width:450px;">
              <input type="text" class="review-input" id="mainReviewInput" placeholder="..." autocomplete="off">
              <div class="feedback-chars" id="feedbackArea"></div>
            </div>
            <div style="margin-top:30px;">
              <button class="btn btn-primary" onclick="window.revealAns()">${getT('btnShowAns')}</button>
            </div>`;
          container.appendChild(card);
          const input = document.getElementById('mainReviewInput'); input.focus();
          input.addEventListener('input', (e)=>{
            currentUserInput = e.target.value; renderFeedback(item.word);
            if (currentUserInput.trim().toLowerCase() === item.word.toLowerCase()){
              setTimeout(()=> window.revealAns(), 300);
            }
          });
          renderFeedback(item.word);
        } else {
          // SRS Button Logic Implementation
          card.innerHTML = `
            <div style="text-align:center;">
              <div class="translation-vn">${escapeHTML(item.vn)}</div>
              <div style="margin:15px 0;"><span class="tag tag-blue">${getT('tagTarget')}</span></div>
              <div style="font-size:50px;font-weight:800;color:var(--primary-dark);margin:5px 0;">
                ${escapeHTML(item.word)} <span class="tag tag-dark" style="font-size:12px;vertical-align:middle;">${escapeHTML(item.pos).toUpperCase()}</span>
              </div>
              <div class="ipa-block" style="justify-content:center;"><span>${escapeHTML(item.ipa)}</span>
                <button class="icon-btn play" onclick="window.speak('${escapeHTML(item.word)}')"><i class="fa-solid fa-volume-high"></i></button>
              </div>
            </div>
            <div style="margin-top:40px;width:100%;display:flex;gap:10px;">
              <button class="btn-srs" onclick="window.handleSrs('again')"><span class="font-bold">${getT('srsAgain')}</span><span class="text-xs text-gray-400">1m</span></button>
              <button class="btn-srs" onclick="window.handleSrs('hard')"><span class="font-bold">${getT('srsHard')}</span><span class="text-xs text-gray-400">5m</span></button>
              <button class="btn-srs" onclick="window.handleSrs('good')"><span class="font-bold">${getT('srsGood')}</span><span class="text-xs text-gray-400">15m</span></button>
              <button class="btn-srs" onclick="window.handleSrs('easy')"><span class="font-bold">${getT('srsEasy')}</span><span class="text-xs text-gray-400">1d</span></button>
            </div>`;
          container.appendChild(card);
        }
      }
      
      // NEW: Handle SRS Logic
      window.handleSrs = (rating) => {
        const item = sessionQueue[currentIdx];
        const now = Date.now();
        let nextReview = now;

        switch(rating) {
            case 'again': nextReview = now + 1 * 60 * 1000; break; // 1 min
            case 'hard': nextReview = now + 5 * 60 * 1000; break;  // 5 min
            case 'good': nextReview = now + 15 * 60 * 1000; break; // 15 min
            case 'easy': nextReview = now + 24 * 60 * 60 * 1000; break; // 1 day
        }

        // Update item in global vocab
        const realIdx = vocab.findIndex(v => v.word === item.word);
        if (realIdx !== -1) {
            vocab[realIdx].nextReview = nextReview;
            vocab[realIdx].lastRating = rating;
            saveCore(); // Save immediately
        }

        // Proceed
        if (currentIdx < sessionQueue.length-1){ 
            currentIdx++; isRevealed = false; currentUserInput = ""; 
            renderReviewContent(document.querySelector('.review-breadcrumb').textContent); 
        } else { 
            document.getElementById('reviewModal').setAttribute('aria-hidden','true'); 
            showMessage("Ho√†n th√†nh √¥n t·∫≠p!"); 
        }
      };

      function renderFeedback(target){
        const area = document.getElementById('feedbackArea'); if (!area) return;
        area.innerHTML = "";
        const targetL = target.toLowerCase(), inputL = currentUserInput.toLowerCase();
        for (let i=0;i<target.length;i++){
          const span = document.createElement('span');
          if (i < inputL.length){
            if (inputL[i] === targetL[i]){ span.textContent = target[i]; span.className = "char-correct"; }
            else { span.textContent = "_"; span.className = "char-wrong"; }
          } else { span.textContent = "_"; span.style.color = "#cbd5e1"; }
          area.appendChild(span);
        }
      }
      window.revealAns = ()=>{ isRevealed = true; renderReviewContent(document.querySelector('.review-breadcrumb').textContent); };
      
      // Removed old window.nextRev as it is replaced by window.handleSrs inside HTML generation

      /* =========================
         MAIN ACTIONS
         ========================= */
      window.speak = t => { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US'; speechSynthesis.speak(u); };

      document.getElementById('aiLookup').onclick = async ()=>{
        const w = fields.word.value.trim(); if (!w) return;
        const btn = document.getElementById('aiLookup');
        btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>...';
        try{
          const prompt = `Define "${w}". Respond strictly in JSON format: {"ipa":"","pos":"","vn":"","engExplain":"","example":"","synonyms":[],"antonyms":[]}`;
          const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contents:[{ parts:[{ text: prompt }]}], generationConfig:{ responseMimeType:"application/json" } })
          });
          const res = await resp.json();
          const data = JSON.parse(res.candidates[0].content.parts[0].text);
          Object.keys(data).forEach(k=>{ if (fields[k]) fields[k].value = Array.isArray(data[k]) ? data[k].join(', ') : data[k]; });
          showMessage("AI tra c·ª©u ho√†n t·∫•t!");
        }catch(e){ showMessage("L·ªói k·∫øt n·ªëi AI!"); }
        finally{ btn.disabled=false; btn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> <span>${getT('btnAi')}</span>`; }
      };

      document.getElementById('addWordBtn').onclick = ()=>{
        const w = fields.word.value.trim(); if (!w) return;
        const item = {
          word: w, ipa: fields.ipa.value, pos: fields.pos.value, vn: fields.vn.value,
          topic: fields.topic.value || 'General', engExplain: fields.engExplain.value,
          example: fields.example.value,
          synonyms: fields.synonyms.value.split(',').map(s=>s.trim()).filter(Boolean),
          antonyms: fields.antonyms.value.split(',').map(s=>s.trim()).filter(Boolean),
          remember: editingIndex >= 0 ? vocab[editingIndex].remember : false
        };
        if (editingIndex >= 0) vocab[editingIndex] = item; else vocab.push(item);
        editingIndex = -1;
        saveCore(); renderTable(); renderLibrary(); renderStats();
        Object.values(fields).forEach(f=> f.value = '');
        document.getElementById('addWordBtn').innerHTML = `<i class="fa-solid fa-plus"></i> <span>${getT('btnAdd')}</span>`;
        showMessage("ƒê√£ l∆∞u t·ª´ v·ª±ng!");
      };

      document.addEventListener('click', e=>{
        const btn = e.target.closest('.icon-btn'); if (!btn) return;
        const idx = parseInt(btn.dataset.idx);
        
        if (btn.classList.contains('rem')){
          vocab[idx].remember = !vocab[idx].remember;
          if (vocab[idx].remember) logActivity(vocab[idx].word);
          saveCore(); renderTable(); renderStats();
          // C·∫≠p nh·∫≠t l·∫°i giao di·ªán Modal n·∫øu ƒëang m·ªü
          const modalOpen = document.getElementById('topicModal').getAttribute('aria-hidden') === 'false';
          if (modalOpen) {
              const topicName = document.getElementById('modalTopicTitle').textContent;
              const filteredWords = vocab.filter(v => (v.topic || "Chung") === topicName);
              renderTopicDetailTable(topicName, filteredWords);
          }
        }
        
        if (btn.classList.contains('edit')){
          editingIndex = idx; const it = vocab[idx];
          Object.keys(fields).forEach(k=> fields[k].value = Array.isArray(it[k]) ? it[k].join(', ') : (it[k]||''));
          document.querySelectorAll('.modal').forEach(m=> m.setAttribute('aria-hidden','true'));
          document.querySelector('[data-view="lookup"]').click();
          document.getElementById('addWordBtn').innerHTML = `<i class="fa-solid fa-check"></i> <span>${getT('btnUpdate')}</span>`;
          window.scrollTo({top:0, behavior:'smooth'});
        }
        
        if (btn.classList.contains('del')){
          if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·ª´ v·ª±ng n√†y kh√¥ng?")) {
            vocab.splice(idx,1); saveCore(); renderTable(); renderLibrary(); renderStats();
            // C·∫≠p nh·∫≠t Modal n·∫øu ƒëang m·ªü
            const modalOpen = document.getElementById('topicModal').getAttribute('aria-hidden') === 'false';
            if (modalOpen) {
                const topicName = document.getElementById('modalTopicTitle').textContent;
                const filteredWords = vocab.filter(v => (v.topic || "Chung") === topicName);
                if (filteredWords.length === 0) closeModal('topicModal');
                else renderTopicDetailTable(topicName, filteredWords);
            }
          }
        }
      });

      // nav switching (m·ªü community s·∫Ω render d·ªØ li·ªáu c·ªông ƒë·ªìng)
      document.querySelectorAll('.nav-item').forEach(btn=>{
        btn.onclick = ()=>{
          document.querySelectorAll('.nav-item').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          const v = btn.dataset.view;
          document.querySelectorAll('.view-section').forEach(s=> s.classList.remove('active'));
          document.getElementById(v + 'Section').classList.add('active');
          if (v === 'library') renderLibrary();
          if (v === 'stats') renderStats();
          if (v === 'community') communityRenderAll(); // g·ªçi render cho Community
        };
      });

      document.getElementById('langToggle').onclick = e=>{ e.stopPropagation(); document.getElementById('langDropdown').classList.toggle('show'); };
      document.querySelectorAll('.lang-option').forEach(o=> o.onclick = ()=>{
        currentLang = o.dataset.lang; localStorage.setItem('vocab_lang', currentLang);
        updateUILanguage(currentLang);
        document.getElementById('langDropdown').classList.remove('show');
        renderTable(); renderLibrary(); renderStats();
      });
      window.updateGuideFormula = function(val, cell, row){
        document.getElementById('guideCellName').innerText = cell;
        document.getElementById('formulaDisplay').innerText = val;
        const allRows = document.querySelectorAll('#guideTableBody tr');
        allRows.forEach(r=> r.style.backgroundColor = 'transparent');
        row.style.backgroundColor = 'var(--bg-cream)';
      };
      document.getElementById('openGuideBtn').onclick = ()=> document.getElementById('guideModal').setAttribute('aria-hidden','false');
      document.getElementById('openImport').onclick = ()=> document.getElementById('fileInput').click();
      document.getElementById('fileInput').onchange = (e)=>{
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt)=>{
          const workbook = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
          const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
          data.forEach(r => vocab.push({
            word: r['T·ª´ v·ª±ng']||r['Word']||'',
            ipa: r['IPA']||'',
            pos: r['Lo·∫°i']||r['Type']||'Noun',
            vn: r['Nghƒ©a Vi·ªát']||r['VN Meaning']||'',
            topic: r['Ch·ªß ƒë·ªÅ']||r['Topic']||'General',
            engExplain: r['Gi·∫£i th√≠ch']||r['Explanation']||'',
            example: r['V√≠ d·ª•']||r['Example']||'',
            synonyms: [], antonyms: [], remember: false
          }));
          saveCore(); renderTable(); renderLibrary(); renderStats(); showMessage("ƒê√£ nh·∫≠p d·ªØ li·ªáu!");
        };
        reader.readAsArrayBuffer(file); e.target.value = "";
      };
      updateUILanguage(currentLang);
      renderTable(); renderStats();
      window.onclick = ()=> document.getElementById('langDropdown').classList.remove('show');

      /* ======================================
         COMMUNITY STATE & HELPERS (Legacy Compatibility)
         ====================================== */
      let commData = JSON.parse(localStorage.getItem('vocab_comm_v1') || JSON.stringify({
        posts:[], challenges:[], groups:[], joinedGroupsCount:0, joinedChallengesCount:0, userChallenges:{}
      }));
      window.openModal = id => document.getElementById(id).setAttribute('aria-hidden','false');
      window.closeModal = id => document.getElementById(id).setAttribute('aria-hidden','true');
      
      // Legacy Feed Render (Kept empty to prevent errors)
      const renderFeed = ()=>{
        const feed = document.getElementById('communityFeed'); if (feed) feed.innerHTML = '';
      };
      const renderChallenges = ()=>{
        const list = document.getElementById('challengeList'); if (list) list.innerHTML = '';
      };
      const renderGroups = ()=>{
        const list = document.getElementById('groupList'); if (list) list.innerHTML = '';
      };

      /* ===== AI Flash Q&A (d√πng API Gemini hi·ªán c√≥) ===== */
      const aiBox = document.getElementById('aiChatBox');
      const appendAi = (role, text)=>{
        const wrap = document.createElement('div');
        wrap.className = `chat-bubble ${role==='user'?'me':'other'}`;
        if (role === 'assistant') {
            wrap.innerHTML = marked.parse(text);
        } else {
            wrap.textContent = text;
        }
        aiBox.appendChild(wrap);
        aiBox.scrollTop = aiBox.scrollHeight;
      };
      document.getElementById('sendAiChat').onclick = async ()=>{
        const inp = document.getElementById('aiChatInput');
        const q = inp.value.trim(); if (!q) return;
        appendAi('user', q); inp.value='';
        try{
          const context = `You are a vocabulary assistant for English learners. When helpful, use short bullet points and examples. Current known topics: ${[...new Set(vocab.map(v=> v.topic||'General'))].slice(0,15).join(', ')}`;
          const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contents:[{ parts:[{ text: context + "\n\nQ: " + q }]}] })
          });
          const data = await resp.json();
          const text = (data?.candidates?.[0]?.content?.parts?.[0]?.text)||"(Kh√¥ng c√≥ ph·∫£n h·ªìi)";
          appendAi('assistant', text);
        }catch(e){ appendAi('assistant', "Xin l·ªói, AI ƒëang b·∫≠n. Vui l√≤ng th·ª≠ l·∫°i!"); }
      };

      /* ===== FEEDBACK STARS ===== */
      document.querySelectorAll('#feedbackStars button').forEach(btn=>{
        btn.onclick = ()=>{
          const idx = parseInt(btn.dataset.index);
          document.querySelectorAll('#feedbackStars button').forEach((b,i)=> b.style.color = i<idx ? '#f59e0b' : '#d1d5db');
        };
      });
      document.getElementById('submitFeedback').onclick = ()=>{
        const t = document.getElementById('feedbackText').value.trim();
        document.getElementById('feedbackText').value = '';
        showMessage("C·∫£m ∆°n g√≥p √Ω c·ªßa b·∫°n!");
      };

      /* =========================
         NEW FEATURES: DISCOVERY LOGIC
         ========================= */
      
      // 1. Creative Workshop
      document.getElementById('btnCreativeFix').onclick = async () => {
        const txt = document.getElementById('creativeInput').value.trim();
        if(!txt) return showMessage("Vui l√≤ng vi·∫øt g√¨ ƒë√≥!");
        const resBox = document.getElementById('creativeResult');
        resBox.style.display = 'block';
        resBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI ƒëang s·ª≠a l·ªói...';
        
        try {
          const prompt = `Correction this English text: "${txt}". Provide 1. Corrected version, 2. Explanation of errors, 3. A better/more native way to say it.`;
          const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contents:[{ parts:[{ text: prompt }]}] })
          });
          const data = await resp.json();
          const text = (data?.candidates?.[0]?.content?.parts?.[0]?.text) || "L·ªói.";
          resBox.innerHTML = marked.parse(text);
        } catch(e) { resBox.textContent = "L·ªói k·∫øt n·ªëi AI."; }
      };

      // *** New: Suggest Words (Feature Requested) ***
      document.getElementById('btnSuggestWords').onclick = () => {
        const learned = vocab.filter(v => v.remember);
        if (learned.length === 0) return showMessage("B·∫°n ch∆∞a thu·ªôc t·ª´ n√†o ƒë·ªÉ g·ª£i √Ω!");
        
        const count = Math.min(5, learned.length);
        const shuffled = [...learned].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, count);
        
        const area = document.getElementById('suggestedWordsArea');
        area.innerHTML = selected.map(v => 
          `<span class="text-[10px] px-2 py-1 bg-white border border-[#F2CE84] rounded-lg text-[#711000] font-bold cursor-pointer hover:bg-[#F2CE84] transition" onclick="document.getElementById('creativeInput').value += '${v.word} '">${v.word}</span>`
        ).join('');
      };


      // 2. Dictation
      let dictationTarget = "";
      document.getElementById('dictationBtn').onclick = () => {
        if(vocab.length === 0) return showMessage("Kho t·ª´ v·ª±ng tr·ªëng!");
        const r = vocab[Math.floor(Math.random() * vocab.length)];
        dictationTarget = r.word;
        document.getElementById('dictationCheck').textContent = "ƒêang ph√°t √¢m...";
        document.getElementById('dictationCheck').style.color = "#888";
        window.speak(dictationTarget);
        document.getElementById('dictationInput').value = '';
        document.getElementById('dictationInput').focus();
      };
      
      document.getElementById('dictationSubmit').onclick = () => {
        if(!dictationTarget) return showMessage("H√£y nh·∫•n n√∫t loa tr∆∞·ªõc!");
        const val = document.getElementById('dictationInput').value.trim();
        const check = document.getElementById('dictationCheck');
        if(val.toLowerCase() === dictationTarget.toLowerCase()){
          check.innerHTML = `<span class="text-green-600"><i class="fas fa-check"></i> Ch√≠nh x√°c! (${dictationTarget})</span>`;
          logActivity(dictationTarget); // t√≠nh v√†o streak
        } else {
          check.innerHTML = `<span class="text-red-500"><i class="fas fa-times"></i> Sai r·ªìi! (${dictationTarget})</span>`;
        }
      };
      
      document.getElementById('dictationSkip').onclick = () => {
        if(dictationTarget) {
            document.getElementById('dictationCheck').innerHTML = `<span class="text-amber-600">ƒê√°p √°n: ${dictationTarget}</span>`;
            dictationTarget = "";
        }
      };

      // 3. Word Network
      document.getElementById('netBtn').onclick = async () => {
        const w = document.getElementById('netInput').value.trim();
        if(!w) return;
        const viz = document.getElementById('netVisual');
        viz.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        
        try {
          const prompt = `Give 3 synonyms and 3 antonyms for "${w}" in JSON: {"syn":["a","b","c"],"ant":["x","y","z"]}`;
          const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contents:[{ parts:[{ text: prompt }]}], generationConfig:{ responseMimeType:"application/json" } })
          });
          const res = await resp.json();
          const data = JSON.parse(res.candidates[0].content.parts[0].text);
          
          viz.innerHTML = '';
          const center = document.createElement('div');
          center.className = 'net-node net-center'; center.textContent = w;
          viz.appendChild(center);
          
          const nodes = [...(data.syn||[]).map(x=>({t:x, c:'syn'})), ...(data.ant||[]).map(x=>({t:x, c:'ant'}))];
          nodes.forEach((n, i) => {
             const ang = (i / nodes.length) * 2 * Math.PI;
             const r = 50; // Smaller radius for compact view
             const x = Math.cos(ang) * r;
             const y = Math.sin(ang) * r;
             
             const el = document.createElement('div');
             el.className = 'net-node net-sub';
             el.textContent = n.t;
             el.style.transform = `translate(${x}px, ${y}px)`;
             if(n.c==='ant') { el.style.borderColor = '#999'; el.style.color='#999'; }
             viz.appendChild(el);
             
             // Draw line (simple visual)
             const line = document.createElement('div');
             line.className = 'net-line';
             line.style.width = '50px';
             line.style.transform = `rotate(${ang * 180 / Math.PI}deg)`;
             viz.appendChild(line);
          });
        } catch(e) { viz.textContent = "L·ªói t·∫°o s∆° ƒë·ªì."; }
      };

      // 4. Roleplay - Enhanced with Toggle Translation
      const rpChat = document.getElementById('roleplayChat');
      
      // Global function for onclick toggle (needs to be on window to work with HTML attribute)
      window.toggleRpLang = (el) => {
          if (!el.dataset.vi) return; // No translation data
          if (el.dataset.lang === 'en') {
              el.textContent = el.dataset.vi;
              el.dataset.lang = 'vi';
              el.classList.add('translated');
          } else {
              el.textContent = el.dataset.en;
              el.dataset.lang = 'en';
              el.classList.remove('translated');
          }
      };

      const appendRp = (role, textEn, textVi = "") => {
        const b = document.createElement('div');
        b.className = `rp-bubble ${role==='ai'?'rp-ai':'rp-user'}`;
        b.textContent = textEn;
        // Set translation data
        b.dataset.en = textEn;
        b.dataset.vi = textVi;
        b.dataset.lang = 'en';
        
        // Add click handler if translation exists
        if(textVi) {
            b.onclick = function() { window.toggleRpLang(this); };
        } else if(role === 'user') {
            // Placeholder for user translation until AI returns it (optional logic)
            b.dataset.vi = "ƒêang d·ªãch...";
            b.onclick = function() { window.toggleRpLang(this); };
        }

        rpChat.appendChild(b);
        rpChat.scrollTop = rpChat.scrollHeight;
        return b; // Return element to update later
      };
      
      document.getElementById('roleplaySend').onclick = async () => {
        const inp = document.getElementById('roleplayInput');
        const txt = inp.value.trim(); if(!txt) return;
        
        // Append user bubble immediately (English)
        const userBubble = appendRp('user', txt, "ƒêang d·ªãch..."); 
        inp.value = '';
        
        const selectBox = document.getElementById('roleplayScenario');
        let scenario = selectBox.value;
        if (scenario === 'custom') {
            scenario = document.getElementById('roleplayCustomInput').value.trim() || 'Free talk';
        } else {
            scenario = selectBox.options[selectBox.selectedIndex].text;
        }
        
        // Enhanced Prompt to get English Response + Translations
        const context = `Act as a character in a scenario about: "${scenario}". User says: "${txt}". 
        Respond in strictly valid JSON format: 
        {
            "response_en": "Your reply in English", 
            "response_vi": "Your reply translated to Vietnamese",
            "user_translated_vi": "The user's text translated to Vietnamese"
        }
        Keep the conversation natural.`;
        
        try {
           const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contents:[{ parts:[{ text: context }]}] })
          });
          const resJson = await resp.json();
          const rawText = (resJson?.candidates?.[0]?.content?.parts?.[0]?.text) || "{}";
          
          // Clean up markdown code blocks if AI adds them
          const cleanJson = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
          const data = JSON.parse(cleanJson);
          
          // Update User Bubble translation
          if(data.user_translated_vi) {
              userBubble.dataset.vi = data.user_translated_vi;
          }
          
          // Append AI Bubble with both languages
          appendRp('ai', data.response_en, data.response_vi);
          
        } catch(e) { 
            console.error(e);
            appendRp('ai', "Error connecting to AI.", "L·ªói k·∫øt n·ªëi AI."); 
        }
      };
      
      // Roleplay Scenario Change Logic
      document.getElementById('roleplayScenario').onchange = (e) => {
        const val = e.target.value;
        const customInput = document.getElementById('roleplayCustomInput');
        rpChat.innerHTML = '';
        
        if(val === 'custom') {
            customInput.classList.remove('hidden');
            customInput.focus();
            appendRp('ai', "What topic would you like to discuss? Enter it above and start!", "B·∫°n mu·ªën th·∫£o lu·∫≠n ch·ªß ƒë·ªÅ g√¨? Nh·∫≠p b√™n tr√™n v√† b·∫Øt ƒë·∫ßu nh√©!");
        } else {
            customInput.classList.add('hidden');
            const txt = e.target.options[e.target.selectedIndex].text;
            appendRp('ai', `Hello! Let's start a conversation about "${txt}".`, `Xin ch√†o! H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªÅ ch·ªß ƒë·ªÅ "${txt}" nh√©.`);
        }
      };

      /* =========================
         NEW FEATURE: WORD RAIN GAME
         ========================= */
      let gameInterval = null;
      let gameScore = 0;
      let gameSpeedMs = 30000;
      const gameContainer = document.getElementById('gameContainer');
      const gameInput = document.getElementById('gameInput');
      
      let fallingWordObj = null;

      document.getElementById('startGameBtn').onclick = () => {
        if(vocab.length < 5) return showMessage("C·∫ßn √≠t nh·∫•t 5 t·ª´ v·ª±ng ƒë·ªÉ ch∆°i!");
        
        // Reset Game
        if(gameInterval) cancelAnimationFrame(gameInterval);
        document.querySelectorAll('.falling-word').forEach(e => e.remove());
        gameScore = 0;
        document.getElementById('currentScore').textContent = '0';
        document.getElementById('gameOverOverlay').style.display = 'none';
        
        const speedVal = parseInt(document.getElementById('gameSpeed').value);
        gameSpeedMs = speedVal * 1000; 
        
        gameInput.value = '';
        gameInput.focus();
        
        fallingWordObj = null;
        let isRunning = true;
        
        function spawnWord() {
            if (fallingWordObj) return;

            const wordObj = vocab[Math.floor(Math.random() * vocab.length)];
            const el = document.createElement('div');
            el.className = 'falling-word';
            el.textContent = `${wordObj.vn} (${wordObj.pos})`;
            el.style.left = Math.max(10, Math.random() * (gameContainer.offsetWidth - 150)) + 'px';
            el.style.top = '0px';
            gameContainer.appendChild(el);
            
            fallingWordObj = {
                el: el,
                y: 0,
                target: wordObj.word.toLowerCase()
            };
        }

        spawnWord(); 
        
        function gameLoop(timestamp) {
            if(!isRunning) return;
            
            if (fallingWordObj) {
                // Move words based on time (approx 16ms frame)
                // Total distance ~320px visible
                // speed = 320 / speedMs
                fallingWordObj.y += (350 / gameSpeedMs) * 16.7; 
                fallingWordObj.el.style.top = fallingWordObj.y + 'px';
                
                // Collision check (Game Over)
                if(fallingWordObj.y > 320) { 
                    isRunning = false;
                    endGame();
                }
            } else {
                spawnWord();
            }
            
            if(isRunning) gameInterval = requestAnimationFrame(gameLoop);
        }
        
        // Input Checking (Enter Key)
        gameInput.onkeydown = (e) => {
            if (!isRunning) return;
            if (e.key === 'Enter') {
                const val = gameInput.value.trim().toLowerCase();
                if (!fallingWordObj) return;

                if (val === fallingWordObj.target) {
                    // Correct
                    fallingWordObj.el.style.backgroundColor = '#4caf50';
                    fallingWordObj.el.style.transform = 'scale(1.5)';
                    fallingWordObj.el.style.opacity = '0';
                    const oldEl = fallingWordObj.el;
                    setTimeout(() => oldEl.remove(), 200);
                    
                    fallingWordObj = null; // Clear to trigger next spawn
                    
                    gameScore += 10;
                    document.getElementById('currentScore').textContent = gameScore;
                    gameInput.value = ''; 
                    
                    spawnWord(); // Force next spawn
                } else {
                    // Wrong -> Game Over
                    isRunning = false;
                    endGame();
                }
            }
        };
        
        // Clear previous oninput if exists to avoid conflicts
        gameInput.oninput = null;
        
        function endGame() {
            document.getElementById('gameOverOverlay').style.display = 'flex';
            document.getElementById('finalScore').textContent = gameScore;
            // Save High Score
            const oldHigh = parseInt(localStorage.getItem('vocab_game_hs') || '0');
            if(gameScore > oldHigh) {
                localStorage.setItem('vocab_game_hs', gameScore);
                document.getElementById('highScoreDisplay').textContent = gameScore;
            }
        }
        
        gameInterval = requestAnimationFrame(gameLoop);
      };
      
      // Init High Score
      document.getElementById('highScoreDisplay').textContent = localStorage.getItem('vocab_game_hs') || '0';


      /* ===== RENDER ALL (Community -> Discovery) ===== */
      const communityRenderAll = ()=>{
        // No longer rendering old community feeds
        // Just ensures stats are synced visually if needed
      };

      communityRenderAll();
    })();
  </script>

  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

      const firebaseConfig = {
          apiKey: "AIzaSyAyQqhC6OjT80nHbn_JoJ1hoJB6Q9hNcB0",
          authDomain: "vocabai-1ef9e.firebaseapp.com",
          projectId: "vocabai-1ef9e",
          storageBucket: "vocabai-1ef9e.firebasestorage.app",
          messagingSenderId: "632372450977",
          appId: "1:632372450977:web:b0723cb4f45a75e69002e0"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const userEl = document.querySelector('.user');

      // Style adjustment for alignment (non-destructive)
      if(userEl) {
          userEl.style.display = 'flex';
          userEl.style.alignItems = 'center';
          userEl.style.gap = '10px';
          userEl.style.cursor = 'default';
      }

      onAuthStateChanged(auth, (user) => {
          if (user) {
              const emailName = user.email ? user.email.split('@')[0] : 'User';
              
              // Keep the styling, change content
              // Add Logout Icon
              userEl.innerHTML = `
                  <span>${emailName}</span>
                  <i class="fa-solid fa-right-from-bracket" id="btnLogout" title="ƒêƒÉng xu·∫•t" style="cursor: pointer; opacity: 0.8; transition: 0.2s;"></i>
              `;

              // Add hover effect via JS to avoid touching CSS file
              const btn = document.getElementById('btnLogout');
              btn.onmouseover = () => btn.style.opacity = '1';
              btn.onmouseout = () => btn.style.opacity = '0.8';
              
              btn.onclick = async () => {
                  try {
                      await signOut(auth);
                      window.location.href = 'logindangnhap.html';
                  } catch (error) {
                      console.error("Logout error", error);
                  }
              };
          } else {
              // No user logged in, redirect to login page
              window.location.href = 'logindangnhap.html';
          }
      });
  </script>

</body>
</html>



